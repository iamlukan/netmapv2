<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netmap v2 - Indoor</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        catppuccin: {
                            base: '#1e1e2e',
                            mantle: '#181825',
                            crust: '#11111b',
                            text: '#cdd6f4',
                            surface0: '#313244',
                            surface1: '#45475a',
                            overlay0: '#6c7086',
                            blue: '#89b4fa',
                            lavender: '#b4befe',
                            red: '#f38ba8',
                            green: '#a6e3a1',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        body {
            background-color: #1e1e2e;
            color: #cdd6f4;
        }

        #map {
            height: calc(100vh - 4rem);
            width: 100%;
            z-index: 10;
            background: #11111b;
        }

        .leaflet-popup-content-wrapper,
        .leaflet-popup-tip {
            background: #181825;
            color: #cdd6f4;
            border: 1px solid #313244;
        }

        .leaflet-container {
            background: #11111b;
        }
    </style>
</head>

<body class="flex flex-col h-screen overflow-hidden font-sans">

    <!-- Header -->
    <header
        class="h-16 bg-catppuccin-mantle border-b border-catppuccin-surface0 flex items-center justify-between px-6">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-catppuccin-lavender">Netmap v2</h1>
            <button onclick="toggleSidebar()"
                class="text-sm bg-catppuccin-surface0 px-3 py-1 rounded hover:bg-catppuccin-surface1">Manage
                Floors</button>
        </div>
        <div id="connection-status" class="flex gap-2 text-xs">
            <span id="status-local" class="px-2 py-1 rounded bg-catppuccin-surface0 text-catppuccin-overlay0">Local:
                Connecting...</span>
            <span id="status-ocs" class="px-2 py-1 rounded bg-catppuccin-surface0 text-catppuccin-overlay0">OCS:
                Connecting...</span>
        </div>
    </header>

    <div class="flex flex-grow relative">
        <!-- Sidebar (Hidden by default) -->
        <aside id="sidebar"
            class="w-64 bg-catppuccin-mantle border-r border-catppuccin-surface0 hidden flex flex-col p-4 z-20 absolute h-full transition-transform">
            <h2 class="text-lg font-bold mb-4">Floor Manager</h2>
            <div id="floor-list" class="space-y-2 mb-4 overflow-y-auto flex-grow">
                <!-- Floors injected here -->
            </div>

            <div class="border-t border-catppuccin-surface0 pt-4">
                <h3 class="text-sm font-bold mb-2">Upload New Floor</h3>
                <form id="upload-form" class="space-y-2 text-xs">
                    <input type="text" id="new-floor-name" placeholder="Name (e.g. 1st Floor)"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0 text-catppuccin-text">
                    <input type="number" id="new-floor-level" placeholder="Order (e.g. 1)"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0 text-catppuccin-text">
                    <input type="file" id="new-floor-file" accept="image/*" class="w-full text-catppuccin-overlay0">
                    <button type="submit"
                        class="w-full bg-catppuccin-blue text-catppuccin-crust font-bold py-2 rounded hover:opacity-90">Upload</button>
                </form>
            </div>
        </aside>

        <!-- Map -->
        <main class="flex-grow relative w-full">
            <div id="map"></div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // Init Map
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -3,
            maxZoom: 2,
            zoomSnap: 0.5
        });

        const floorLayers = {};
        const layerControl = L.control.layers(null, null, { collapsed: false, position: 'topright' }).addTo(map);
        let currentFloorId = null;
        let floorsData = [];
        let markersLayer = L.layerGroup().addTo(map);
        let allNodes = [];

        async function init() {
            await fetchFloors();
            await fetchNodes();
            // Start connection check loop
            checkConnection();
            setInterval(checkConnection, 30000);
        }

        async function fetchFloors() {
            try {
                const res = await fetch('/api/floors');
                floorsData = await res.json();

                // Clear existing
                // Warning: removing layers from control is tricky in Leaflet without rebuild
                // For MVP, we presume page reload on big changes, but we try to rebuild control
                layerControl.remove();
                const newControl = L.control.layers(null, null, { collapsed: false, position: 'topright' }).addTo(map);

                const sidebarList = document.getElementById('floor-list');
                sidebarList.innerHTML = '';

                // If no floors, show a default msg or empty map
                if (floorsData.length === 0) {
                    L.popup().setLatLng([0, 0]).setContent("No floors defined. Upload one in Manage Floors.").openOn(map);
                    return;
                }

                floorsData.forEach((floor, index) => {
                    // Create Image Overlay
                    const bounds = [[0, 0], [floor.height, floor.width]];
                    const layer = L.imageOverlay(floor.image_path, bounds);

                    floorLayers[floor.id] = layer;
                    newControl.addBaseLayer(layer, floor.name);

                    // Sidebar Item
                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center bg-catppuccin-surface0 p-2 rounded";
                    item.innerHTML = `<span>${floor.name}</span> <span class="text-xs text-catppuccin-overlay0">Lvl ${floor.level_order}</span>`;
                    sidebarList.appendChild(item);

                    // Set default if first
                    if (index === 0) {
                        layer.addTo(map);
                        map.fitBounds(bounds);
                        currentFloorId = floor.id;
                    }
                });

            } catch (e) {
                console.error("Error fetching floors:", e);
            }
        }

        async function fetchNodes() {
            const res = await fetch('/api/nodes');
            const data = await res.json();
            allNodes = data.features;
            updateMarkers();
        }

        function updateMarkers() {
            if (!currentFloorId) return;

            markersLayer.clearLayers();
            const visibleNodes = allNodes.filter(n => n.properties.floor_id === currentFloorId);

            visibleNodes.forEach(f => {
                const [y, x] = f.geometry.coordinates; // GeoJSON [x,y] -> Leaflet [lat(y), lng(x)]

                const marker = L.circleMarker([x, y], {
                    radius: 6,
                    fillColor: "#a6e3a1",
                    color: "#11111b",
                    weight: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <b>${f.properties.name}</b><br>
                    IP: ${f.properties.ip_address}<br>
                    Type: ${f.properties.type}
                `);

                markersLayer.addLayer(marker);
            });
        }

        // Map Events
        map.on('baselayerchange', function (e) {
            // Find floor ID by name (or layer ref)
            const floor = floorsData.find(f => f.name === e.name);
            if (floor) {
                currentFloorId = floor.id;
                // Update bounds
                const bounds = [[0, 0], [floor.height, floor.width]];
                map.setMaxBounds(bounds); // Restrict to new floor size
                // Optionally fit bounds? map.fitBounds(bounds); 
                updateMarkers();
            }
        });

        // Sidebar logic
        function toggleSidebar() {
            const el = document.getElementById('sidebar');
            el.classList.toggle('hidden');
        }

        // Upload Form
        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('name', document.getElementById('new-floor-name').value);
            formData.append('level_order', document.getElementById('new-floor-level').value);
            formData.append('file', document.getElementById('new-floor-file').files[0]);

            try {
                const res = await fetch('/api/floors/upload', {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    alert('Floor uploaded!');
                    location.reload(); // Simple refresh to load new state
                } else {
                    alert('Upload failed');
                }
            } catch (err) {
                console.error(err);
                alert('Error uploading');
            }
        });

        // Diagnostics
        async function checkConnection() {
            try {
                const res = await fetch('/api/test-db');
                const status = await res.json();
                document.getElementById('status-local').textContent = `Local: ${status.local}`;
                document.getElementById('status-ocs').textContent = `OCS: ${status.ocs}`;
            } catch (e) { }
        }

        init();

        map.on('click', e => {
            console.log(`Coords: [${e.latlng.lng.toFixed(0)}, ${e.latlng.lat.toFixed(0)}]`);
            L.popup().setLatLng(e.latlng).setContent(`[${e.latlng.lng.toFixed(0)}, ${e.latlng.lat.toFixed(0)}]`).openOn(map);
        });
    </script>
</body>

</html>