<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netmap v2 - Indoor</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        catppuccin: {
                            base: '#1e1e2e',
                            mantle: '#181825',
                            crust: '#11111b',
                            text: '#cdd6f4',
                            surface0: '#313244',
                            surface1: '#45475a',
                            overlay0: '#6c7086',
                            blue: '#89b4fa',
                            lavender: '#b4befe',
                            red: '#f38ba8',
                            green: '#a6e3a1',
                            yellow: '#f9e2af',
                            mauve: '#cba6f7',
                            peach: '#fab387'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        body {
            background-color: #1e1e2e;
            color: #cdd6f4;
        }

        #map {
            height: calc(100vh - 4rem);
            width: 100%;
            z-index: 10;
            background: #11111b;
        }

        /* Popup Styling */
        .leaflet-popup-content-wrapper,
        .leaflet-popup-tip {
            background: #181825;
            color: #cdd6f4;
            border: 1px solid #313244;
        }

        /* Tooltip Styling */
        .leaflet-tooltip.nm-tooltip {
            background-color: #1e1e2e !important;
            border-width: 1px;
            border-style: solid;
            border-radius: 4px;
            font-family: sans-serif;
            font-size: 11px;
            font-weight: 600;
            line-height: 1.2;
            padding: 2px 5px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            opacity: 1 !important;
        }

        .nm-tooltip-green {
            border-color: #a6e3a1;
            color: #a6e3a1;
        }

        .nm-tooltip-yellow {
            border-color: #f9e2af;
            color: #f9e2af;
        }

        .nm-tooltip-red {
            border-color: #f38ba8;
            color: #f38ba8;
        }

        .nm-tooltip-gray {
            border-color: #6c7086;
            color: #6c7086;
        }

        .nm-tooltip-mauve {
            border-color: #cba6f7;
            color: #cba6f7;
        }

        .nm-tooltip-blue {
            border-color: #89b4fa;
            color: #89b4fa;
        }

        .leaflet-tooltip {
            background-color: transparent;
            border: none;
            box-shadow: none;
        }

        .leaflet-tooltip-left:before,
        .leaflet-tooltip-right:before {
            border: none !important;
        }

        .leaflet-container {
            background: #11111b;
        }

        .cursor-crosshair {
            cursor: crosshair !important;
        }

        /* Draggable Items */
        .draggable-item {
            cursor: grab;
        }

        .draggable-item:active {
            cursor: grabbing;
        }
    </style>
</head>

<body class="flex flex-col h-screen overflow-hidden font-sans">

    <!-- Header -->
    <header
        class="h-16 bg-catppuccin-mantle border-b border-catppuccin-surface0 flex items-center justify-between px-6 z-30 relative">
        <div class="flex items-center gap-4">
            <h1
                class="text-xl font-bold bg-gradient-to-r from-catppuccin-blue to-catppuccin-lavender bg-clip-text text-transparent">
                Netmap BandRio</h1>
            <button onclick="toggleSidebar()"
                class="text-sm bg-catppuccin-surface0 px-3 py-1 rounded hover:bg-catppuccin-surface1">Gerenciar
                Andares</button>
            <button id="btn-insert" onclick="toggleInsertMode()"
                class="text-sm bg-catppuccin-blue text-catppuccin-crust font-bold px-3 py-1 rounded hover:opacity-90">Inserir</button>
            <button onclick="toggleRightSidebar()"
                class="text-sm bg-catppuccin-peach text-catppuccin-crust font-bold px-3 py-1 rounded hover:opacity-90">Invent√°rio
                Pendente</button>
        </div>
        <div id="connection-status" class="flex gap-2 text-xs">
            <span id="status-local" class="px-2 py-1 rounded bg-catppuccin-surface0 text-catppuccin-overlay0">Local:
                Connecting...</span>
            <span id="status-ocs" class="px-2 py-1 rounded bg-catppuccin-surface0 text-catppuccin-overlay0">OCS:
                Connecting...</span>
        </div>
    </header>

    <div class="flex flex-grow relative">
        <!-- Sidebar Left (Floor Manager) -->
        <aside id="sidebar"
            class="w-80 bg-catppuccin-mantle border-r border-catppuccin-surface0 hidden flex-col p-4 z-20 absolute h-full transition-transform left-0 top-0 pt-20">
            <h2 class="text-lg font-bold mb-4">Gerenciar Andares</h2>
            <div id="floor-list" class="space-y-2 mb-4 overflow-y-auto flex-grow"></div>
            <div class="border-t border-catppuccin-surface0 pt-4">
                <h3 class="text-sm font-bold mb-2">Upload Novo Andar</h3>
                <form id="upload-form" class="space-y-2 text-xs">
                    <input type="text" id="new-floor-name" placeholder="Nome (ex: T√©rreo)"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0 text-catppuccin-text">
                    <input type="number" id="new-floor-level" placeholder="Ordem (ex: 1)"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0 text-catppuccin-text">
                    <input type="file" id="new-floor-file" accept="image/*" class="w-full text-catppuccin-overlay0">
                    <button type="submit"
                        class="w-full bg-catppuccin-blue text-catppuccin-crust font-bold py-2 rounded hover:opacity-90">Upload</button>
                </form>
            </div>
        </aside>

        <!-- Sidebar Right (Pending Inventory) -->
        <aside id="sidebar-right"
            class="w-80 bg-catppuccin-mantle border-l border-catppuccin-surface0 hidden flex-col p-4 z-20 absolute h-full transition-transform right-0 top-0 pt-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-catppuccin-peach">Invent√°rio Pendente <span id="inventory-count"
                        class="text-sm text-catppuccin-text opacity-75"></span></h2>
                <button onclick="fetchAudit()" class="text-xs text-catppuccin-blue hover:text-white">‚Üª
                    Atualizar</button>
            </div>

            <input type="text" id="search-ocs" onkeyup="filterOCSList()" placeholder="üîç Pesquisar M√°quina..."
                class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0 text-sm mb-2 text-catppuccin-text">

            <p class="text-xs text-catppuccin-overlay0 mb-4">Arraste para o mapa para posicionar.</p>
            <div id="inventory-list" class="space-y-2 overflow-y-auto flex-grow pb-20">
                <!-- Items will be injected here -->
                <div class="text-center text-catppuccin-overlay0 text-sm mt-10">Carregando...</div>
            </div>
        </aside>

        <!-- Hidden input for file replacement -->
        <input type="file" id="replace-file-input" accept="image/*" class="hidden">

        <!-- Insert/Edit Modal -->
        <div id="insert-modal"
            class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-catppuccin-mantle border border-catppuccin-surface0 p-6 rounded shadow-xl z-30 w-80">
            <h3 id="modal-title" class="text-lg font-bold mb-4 text-catppuccin-lavender">Inserir Item</h3>
            <form id="insert-form" class="space-y-3">
                <input type="hidden" id="insert-id">
                <input type="hidden" id="insert-x">
                <input type="hidden" id="insert-y">

                <div>
                    <label class="block text-xs text-catppuccin-overlay0 mb-1">Tipo</label>
                    <select id="insert-type"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0"
                        onchange="handleTypeChange()">
                        <option value="Computador">Computador</option>
                        <option value="Ponto">Ponto de Rede (Vazio)</option>
                        <option value="Ramal">Ramal</option>
                        <option value="Equipamento">Equipamento</option>
                    </select>
                </div>

                <div id="field-name">
                    <label id="label-name" class="block text-xs text-catppuccin-overlay0 mb-1">Nome</label>
                    <input type="text" id="insert-name" placeholder="Nome do Item"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0">
                </div>

                <div id="field-point">
                    <label class="block text-xs text-catppuccin-overlay0 mb-1">Ponto de Rede</label>
                    <input type="text" id="insert-point" placeholder="Ex: 160"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0">
                </div>

                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" onclick="closeInsertModal()"
                        class="px-3 py-1 bg-catppuccin-surface0 rounded hover:bg-catppuccin-surface1">Cancelar</button>
                    <button type="submit" id="btn-save-modal"
                        class="px-3 py-1 bg-catppuccin-blue text-catppuccin-crust font-bold rounded hover:opacity-90">Salvar</button>
                </div>
            </form>
        </div>

        <!-- Map -->
        <!-- Add dragover/drop handlers -->
        <main class="flex-grow relative w-full" ondrop="handleDrop(event)" ondragover="allowDrop(event)">
            <div id="map"></div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const map = L.map('map', { crs: L.CRS.Simple, minZoom: -3, maxZoom: 2, zoomSnap: 0.5 });
        const layerControl = L.control.layers(null, null, { collapsed: false, position: 'topright' }).addTo(map);
        let currentFloorId = null;
        let floorsData = [];
        let markersLayer = L.layerGroup().addTo(map);
        let allNodes = [];
        let floorToReplace = null;
        let isInsertMode = false;
        let insertMarker = null;

        async function init() {
            // AUTH CHECK
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/static/login.html';
                return;
            }

            await fetchFloors();
            await fetchNodes();
            await fetchStatusMap(); // New call
            checkConnection();
            fetchAudit();
            setInterval(checkConnection, 30000);
            setInterval(fetchStatusMap, 60000); // Poll status every minute
        }

        async function fetchFloors() {
            try {
                const res = await fetchWithAuth('/api/floors');
                floorsData = await res.json();
                layerControl.remove();
                const newControl = L.control.layers(null, null, { collapsed: false, position: 'topright' }).addTo(map);
                const sidebarList = document.getElementById('floor-list');
                sidebarList.innerHTML = '';
                floorsData.forEach((floor, index) => {
                    const bounds = [[0, 0], [floor.height, floor.width]];
                    const layer = L.imageOverlay(floor.image_path, bounds);
                    newControl.addBaseLayer(layer, floor.name);
                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center bg-catppuccin-surface0 p-2 rounded text-sm";
                    item.innerHTML = `<div><div class='font-bold'>${floor.name}</div><div class='text-xs text-catppuccin-overlay0'>Lvl ${floor.level_order}</div></div><div class="flex gap-2"><button onclick="triggerReplace(${floor.id})" class="hover:text-catppuccin-blue">‚ôªÔ∏è</button><button onclick="deleteFloor(${floor.id})" class="hover:text-catppuccin-red">üóëÔ∏è</button></div>`;
                    sidebarList.appendChild(item);
                    if (index === 0 && !currentFloorId) { layer.addTo(map); map.fitBounds(bounds); currentFloorId = floor.id; }
                });
            } catch (e) { console.error(e); }
        }

        async function fetchNodes() {
            try { const res = await fetchWithAuth('/api/nodes'); const data = await res.json(); allNodes = data.features; updateMarkers(); } catch (e) { }
        }

        // DRAG AND DROP LOGIC
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function filterOCSList() {
            const input = document.getElementById('search-ocs');
            const filter = input.value.toUpperCase();
            const list = document.getElementById("inventory-list");
            const items = list.getElementsByClassName('draggable-item');

            for (let i = 0; i < items.length; i++) {
                const txtValue = items[i].innerText || items[i].textContent;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    items[i].style.display = "";
                } else {
                    items[i].style.display = "none";
                }
            }
        }

        function drag(ev, name) {
            ev.dataTransfer.setData("machineName", name);
        }

        async function handleDrop(ev) {
            ev.preventDefault();
            if (!currentFloorId) return alert("Selecione um andar primeiro!");

            const machineName = ev.dataTransfer.getData("machineName");
            if (!machineName) return;

            // Calculate Map Coordinates from Drop Event
            // map.mouseEventToLatLng requires a MouseEvent. 'ev' is a DragEvent which inherits from MouseEvent but we rely on Leaflet.
            // Leaflet map container relative position calculation:
            const containerPoint = map.mouseEventToContainerPoint(ev);
            const latLng = map.containerPointToLatLng(containerPoint);

            // Auto-Save Node
            // We assume it's type 'Computador' since it came from Inventory list
            const payload = {
                name: machineName,
                type: 'Computador',
                point_number: null,
                floor_id: currentFloorId,
                x: latLng.lng, // X is Lng (Width)
                y: latLng.lat  // Y is Lat (Height)
            };

            if (confirm(`Adicionar ${machineName} nesta posi√ß√£o?`)) {
                try {
                    const res = await fetchWithAuth('/api/nodes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (res.ok) {
                        fetchNodes(); // Refresh map
                        fetchAudit(); // Refresh sidebar (should remove item)
                    } else {
                        alert("Erro ao salvar item.");
                    }
                } catch (e) {
                    alert("Erro de conex√£o.");
                }
            }
        }

        async function fetchAudit() {
            const container = document.getElementById('inventory-list');
            try {
                const res = await fetchWithAuth('/api/inventory/audit');
                const data = await res.json();

                if (data.error) {
                    container.innerHTML = `<div class="text-red-400 text-xs p-2">${data.error}</div>`;
                    return;
                }

                container.innerHTML = '';
                const missingInMap = data.missing_in_map || [];

                // Update Count
                const countEl = document.getElementById('inventory-count');
                if (countEl) countEl.innerText = `(${missingInMap.length})`;

                if (missingInMap.length === 0) {
                    container.innerHTML = `<div class="text-catppuccin-green text-xs p-2">Tudo sincronizado!</div>`;
                    return;
                }

                missingInMap.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "bg-catppuccin-surface0 p-2 rounded text-sm flex justify-between items-center draggable-item hover:bg-catppuccin-surface1 transition-colors";
                    div.draggable = true;
                    div.ondragstart = (ev) => drag(ev, item.name);

                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-catppuccin-text">üñ•Ô∏è ${item.name}</div>
                            <div class="text-[10px] text-catppuccin-overlay0">${item.tag || 'Sem TAG'}</div>
                        </div>
                        <div class="text-catppuccin-peach">‚ãÆ</div>
                    `;
                    container.appendChild(div);
                });

            } catch (e) {
                container.innerHTML = `<div class="text-red-400 text-xs p-2">Erro ao carregar auditoria.</div>`;
            }
        }

        async function fetchOCSData(hostname, container) {
            try {
                container.innerHTML = "<span class='text-xs text-catppuccin-overlay0 animate-pulse'>Buscando OCS...</span>";
                const res = await fetchWithAuth(`/api/ocs/machine/${hostname}`);
                if (res.ok) {
                    const data = await res.json();
                    container.innerHTML = `
                        <div class="bg-catppuccin-surface0 p-2 rounded mt-2 text-xs">
                            <p class="font-bold text-catppuccin-green">‚úì Sincronizado</p>
                            <p>OS: ${data.OSNAME || 'N/A'}</p>
                            <p>IP: ${data.IPADDR || 'N/A'}</p>
                            <p>User: ${data.USERID || 'N/A'}</p>
                            <p>Last: ${data.LASTDATE || 'N/A'}</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = "<span class='text-xs text-gray-500'>Sem dados no OCS</span>";
                }
            } catch (e) {
                container.innerHTML = "<span class='text-xs text-red-400'>Erro OCS</span>";
            }
        }

        // Global status map
        let nodeStatusMap = {};

        async function fetchStatusMap() {
            try {
                const res = await fetchWithAuth('/api/inventory/status');
                if (res.ok) {
                    nodeStatusMap = await res.json();
                    updateMarkers(); // Refresh colors
                }
            } catch (e) { console.error("Status fetch failed", e); }
        }

        function updateMarkers() {
            if (!currentFloorId) return;
            markersLayer.clearLayers();
            const visibleNodes = allNodes.filter(n => n.properties.floor_id === currentFloorId);

            visibleNodes.forEach(f => {
                const [y, x] = f.geometry.coordinates;
                let colorClass = "nm-tooltip-green"; // Default
                let colorHex = "#a6e3a1"; // Default Green
                let tooltipContent = "";
                let type = f.properties.type;
                let id = f.id;

                // Determine Color based on Status Map (Only for Computers)
                // Updated Logic: Computers get Green/Gray/Red.
                // Ramal gets Purple (Mauve).
                if (type === 'Computador') {
                    const status = nodeStatusMap[id];
                    if (status === 'red') {
                        colorClass = "nm-tooltip-red";
                        colorHex = "#f38ba8";
                        // Alert Icon for Red Computers
                        if (!tooltipContent.includes("‚ö†Ô∏è")) tooltipContent = "‚ö†Ô∏è " + tooltipContent;
                    } else if (status === 'gray') {
                        colorClass = "nm-tooltip-gray";
                        colorHex = "#6c7086"; // Catppuccin Overlay0
                    } else {
                        // Default Green (Active)
                        colorClass = "nm-tooltip-green";
                        colorHex = "#a6e3a1";
                    }
                } else if (type === 'Ponto') {
                    colorClass = "nm-tooltip-yellow"; colorHex = "#f9e2af";
                } else if (type === 'Ramal') {
                    colorClass = "nm-tooltip-mauve"; colorHex = "#cba6f7"; // Changed from Red to Mauve
                } else if (type === 'Equipamento') {
                    colorClass = "nm-tooltip-blue"; colorHex = "#89b4fa";
                }

                if (type === 'Ponto') {
                    tooltipContent = `P: ${f.properties.point_number || '?'}`;
                } else if (type === 'Ramal') {
                    tooltipContent = `${f.properties.name}`;
                } else if (type === 'Equipamento') {
                    // Updated: Show Name + Point Number for Equipment
                    tooltipContent = `<span class="font-bold">${f.properties.name}</span>`;
                    if (f.properties.point_number) tooltipContent += `<br><span class="opacity-75">P: ${f.properties.point_number}</span>`;
                } else {
                    // Computer
                    tooltipContent = `<span class="font-bold">${f.properties.name}</span>`;
                    if (f.properties.point_number) tooltipContent += `<br><span class="opacity-75">P: ${f.properties.point_number}</span>`;
                }

                const marker = L.circleMarker([x, y], { radius: 4, fillColor: colorHex, color: "#11111b", weight: 1, fillOpacity: 0.9 }).addTo(markersLayer);
                marker.bindTooltip(tooltipContent, { permanent: true, direction: 'top', className: `nm-tooltip ${colorClass}`, offset: [0, -4] });

                const popupDiv = document.createElement('div');
                popupDiv.className = "flex flex-col gap-2 min-w-[150px]";
                popupDiv.innerHTML = `<p class="font-bold border-b border-gray-600 pb-1">${f.properties.name}</p>`;

                // Alert Message for Ghost Machines
                if (type === 'Computador' && nodeStatusMap[id] === 'red') {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = "text-xs bg-red-900/50 text-red-200 p-1 rounded border border-red-500/50 mb-1 flex items-center gap-1";
                    alertDiv.innerHTML = "<span>‚ö†Ô∏è</span> <span>M√°quina n√£o inventariada no OCS</span>";
                    popupDiv.appendChild(alertDiv);
                }

                // OCS Section
                const ocsDiv = document.createElement('div');
                ocsDiv.id = `ocs-${f.id}`;
                popupDiv.appendChild(ocsDiv);

                const editBtn = document.createElement('button');
                editBtn.className = "text-xs text-catppuccin-blue hover:text-white w-full text-left mt-1";
                editBtn.innerText = "‚úèÔ∏è Editar Item";
                editBtn.onclick = () => openEditModal(f);

                const delBtn = document.createElement('button');
                delBtn.className = "text-xs text-red-400 hover:text-red-300 w-full text-left";
                delBtn.innerText = "üóëÔ∏è Remover Item";
                delBtn.onclick = () => deleteNode(f.id);

                popupDiv.appendChild(editBtn);
                popupDiv.appendChild(delBtn);

                marker.bindPopup(popupDiv);

                // Fetch OCS when popup opens
                marker.on('popupopen', () => {
                    if (f.properties.type === 'Computador') fetchOCSData(f.properties.name, ocsDiv);
                });
            });
        }

        function toggleInsertMode() { closeInsertModal(); isInsertMode = !isInsertMode; document.getElementById('btn-insert').classList.toggle('bg-catppuccin-red', isInsertMode); document.getElementById('map').classList.toggle('cursor-crosshair', isInsertMode); document.getElementById('btn-insert').innerText = isInsertMode ? "Cancelar Inser√ß√£o" : "Inserir Manual"; }
        function closeInsertModal() { document.getElementById('insert-modal').classList.add('hidden'); if (insertMarker) { map.removeLayer(insertMarker); insertMarker = null; } resetForm(); }
        function resetForm() { document.getElementById('insert-id').value = ''; document.getElementById('insert-form').reset(); document.getElementById('modal-title').innerText = "Inserir Item"; document.getElementById('btn-save-modal').innerText = "Salvar"; }
        function openEditModal(f) { map.closePopup(); document.getElementById('insert-id').value = f.id; document.getElementById('insert-type').value = f.properties.type; if (f.properties.type === 'Ponto') document.getElementById('insert-point').value = f.properties.point_number; else { document.getElementById('insert-name').value = f.properties.name; document.getElementById('insert-point').value = f.properties.point_number || ''; } const [y, x] = f.geometry.coordinates; document.getElementById('insert-x').value = x; document.getElementById('insert-y').value = y; handleTypeChange(); document.getElementById('modal-title').innerText = "Editar Item"; document.getElementById('btn-save-modal').innerText = "Atualizar"; document.getElementById('insert-modal').classList.remove('hidden'); }
        function handleTypeChange() { const t = document.getElementById('insert-type').value; const nd = document.getElementById('field-name'); const pd = document.getElementById('field-point'); const ln = document.getElementById('label-name'); if (t === 'Ponto') { nd.classList.add('hidden'); pd.classList.remove('hidden'); } else if (t === 'Ramal') { nd.classList.remove('hidden'); ln.innerText = "N√∫mero do Ramal"; pd.classList.add('hidden'); } else { nd.classList.remove('hidden'); ln.innerText = "Nome"; pd.classList.remove('hidden'); } }
        document.getElementById('insert-form').addEventListener('submit', async e => { e.preventDefault(); if (!currentFloorId) return alert("Selecione um andar!"); const id = document.getElementById('insert-id').value; const t = document.getElementById('insert-type').value; let n = document.getElementById('insert-name').value; const p = document.getElementById('insert-point').value; const x = parseFloat(document.getElementById('insert-x').value); const y = parseFloat(document.getElementById('insert-y').value); if (t === 'Ponto') n = `Ponto ${p}`; const pay = { name: n || "Sem Nome", type: t, point_number: p || null, floor_id: currentFloorId }; let u = '/api/nodes', m = 'POST'; if (id) { u += `/${id}`; m = 'PUT'; } else { pay.x = x; pay.y = y; } await fetchWithAuth(u, { method: m, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(pay) }); closeInsertModal(); if (isInsertMode) toggleInsertMode(); fetchNodes(); fetchAudit(); });
        async function deleteNode(id) { if (confirm("Remover?")) { await fetchWithAuth(`/api/nodes/${id}`, { method: 'DELETE' }); fetchNodes(); fetchAudit(); } }
        map.on('click', e => { if (!isInsertMode) return; resetForm(); if (insertMarker) map.removeLayer(insertMarker); insertMarker = L.circleMarker(e.latlng, { radius: 6, color: 'white' }).addTo(map); document.getElementById('insert-modal').classList.remove('hidden'); document.getElementById('insert-x').value = e.latlng.lng.toFixed(2); document.getElementById('insert-y').value = e.latlng.lat.toFixed(2); handleTypeChange(); });
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); document.getElementById('sidebar').classList.toggle('flex'); }
        function toggleRightSidebar() { document.getElementById('sidebar-right').classList.toggle('hidden'); document.getElementById('sidebar-right').classList.toggle('flex'); }
        async function deleteFloor(id) { if (confirm("Confirmar?")) fetchWithAuth(`/api/floors/${id}`, { method: 'DELETE' }).then(() => location.reload()); }
        function triggerReplace(id) { floorToReplace = id; document.getElementById('replace-file-input').click(); }
        document.getElementById('replace-file-input').addEventListener('change', async e => { const fd = new FormData(); fd.append('file', e.target.files[0]); await fetchWithAuth(`/api/floors/${floorToReplace}/image`, { method: 'POST', body: fd }); location.reload(); });
        document.getElementById('upload-form').addEventListener('submit', async e => { e.preventDefault(); const fd = new FormData(); fd.append('name', document.getElementById('new-floor-name').value); fd.append('level_order', document.getElementById('new-floor-level').value); fd.append('file', document.getElementById('new-floor-file').value ? document.getElementById('new-floor-file').files[0] : null); await fetchWithAuth('/api/floors/upload', { method: 'POST', body: fd }); location.reload(); });
        map.on('baselayerchange', e => { const f = floorsData.find(fl => fl.name === e.name); if (f) { currentFloorId = f.id; map.setMaxBounds([[0, 0], [f.height, f.width]]); updateMarkers(); } });
        async function checkConnection() { try { const r = await fetch('/api/test-db'); const s = await r.json(); document.getElementById('status-local').innerText = `Local: ${s.local}`; document.getElementById('status-ocs').innerText = `ocs: ${s.ocs}`; } catch (e) { } }
        init();
    </script>
</body>

</html>