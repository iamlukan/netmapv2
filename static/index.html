<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netmap v2 - Indoor</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        catppuccin: {
                            base: '#1e1e2e',
                            mantle: '#181825',
                            crust: '#11111b',
                            text: '#cdd6f4',
                            surface0: '#313244',
                            surface1: '#45475a',
                            overlay0: '#6c7086',
                            blue: '#89b4fa',
                            lavender: '#b4befe',
                            red: '#f38ba8',
                            green: '#a6e3a1',
                            yellow: '#f9e2af',
                            mauve: '#cba6f7',
                            peach: '#fab387'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        body {
            background-color: #1e1e2e;
            color: #cdd6f4;
        }

        #map {
            height: calc(100vh - 4rem);
            width: 100%;
            z-index: 10;
            background: #11111b;
        }

        /* Popup Styling */
        .leaflet-popup-content-wrapper,
        .leaflet-popup-tip {
            background: #181825;
            color: #cdd6f4;
            border: 1px solid #313244;
        }

        /* Tooltip Styling */
        .leaflet-tooltip.nm-tooltip {
            background-color: #1e1e2e !important;
            border-width: 1px;
            border-style: solid;
            border-radius: 4px;
            font-family: sans-serif;
            font-size: 11px;
            font-weight: 600;
            line-height: 1.2;
            padding: 2px 5px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            opacity: 1 !important;
        }

        .nm-tooltip-green {
            border-color: #a6e3a1;
            color: #a6e3a1;
        }

        .nm-tooltip-yellow {
            border-color: #f9e2af;
            color: #f9e2af;
        }

        .nm-tooltip-red {
            border-color: #f38ba8;
            color: #f38ba8;
        }

        .nm-tooltip-gray {
            border-color: #6c7086;
            color: #6c7086;
        }

        .nm-tooltip-mauve {
            border-color: #cba6f7;
            color: #cba6f7;
        }

        .nm-tooltip-blue {
            border-color: #89b4fa;
            color: #89b4fa;
        }

        .leaflet-tooltip {
            background-color: transparent;
            border: none;
            box-shadow: none;
        }

        .nm-tooltip-text {
            background: rgba(30, 30, 46, 0.7) !important;
            /* Semi-transparent dark background */
            border: 1px solid rgba(166, 173, 200, 0.3) !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5) !important;
            font-size: 14px !important;
            color: #cdd6f4 !important;
            white-space: pre-wrap !important;
            /* Support multiline */
            padding: 4px 8px !important;
            border-radius: 6px !important;
            pointer-events: auto !important;
            /* Enable selection */
            cursor: text;
        }

        .leaflet-tooltip-left:before,
        .leaflet-tooltip-right:before {
            border: none !important;
        }

        .leaflet-container {
            background: #11111b;
        }

        .cursor-crosshair {
            cursor: crosshair !important;
        }

        /* Draggable Items */
        .draggable-item {
            cursor: grab;
        }

        .draggable-item:active {
            cursor: grabbing;
        }

        /* Dynamic Popup Positioning */
        .popup-below {
            margin-bottom: 0 !important;
        }

        .leaflet-popup-content {
            max-height: 50vh;
            /* Limit height to half screen */
            overflow-y: auto;
            /* Enable scroll */
            overflow-x: hidden;
            padding-right: 5px;
            width: auto !important;
            min-width: 250px;
        }

        /* Scrollbar Styling */
        /* Scrollbar Styling */
        .leaflet-popup-content::-webkit-scrollbar {
            width: 4px;
            /* Thinner */
        }

        .leaflet-popup-content::-webkit-scrollbar-track {
            background: transparent;
            /* Invisible track */
        }

        .leaflet-popup-content::-webkit-scrollbar-thumb {
            background: #45475a;
            border-radius: 4px;
        }

        /* Hide scrollbar when not hovering? Optional */
        /* .leaflet-popup-content:not(:hover)::-webkit-scrollbar-thumb { background: transparent; } */

        .popup-below .leaflet-popup-content-wrapper {
            transform: translateY(calc(100% + 15px));
        }

        .popup-below .leaflet-popup-tip-container {
            top: 0;
            bottom: auto;
            transform: translateY(calc(100% + 14px)) rotate(180deg);
        }

        /* Horizontal Alignment for Corners */
        .popup-align-right .leaflet-popup-content-wrapper {
            margin-left: 80px;
            /* Shift body right */
        }

        .popup-align-left .leaflet-popup-content-wrapper {
            margin-right: 80px;
            /* Shift body left */
            margin-left: -80px;
            /* Counter-act default centering if needed, but margin-right usually pushes. Leaflet centers with left: -50%. */
            /* Actually, Leaflet wrapper is width: auto. 
               The container is positioned. 
               The wrapper is inside.
               Simplest check is translateX.
            */
            transform: translateX(-40%);
        }

        .popup-align-right .leaflet-popup-content-wrapper {
            margin-left: 0;
            transform: translateX(40%);
        }

        /* Composite Transforms for Below + Horizontal */
        .popup-below.popup-align-right .leaflet-popup-content-wrapper {
            transform: translateY(calc(100% + 15px)) translateX(40%);
        }

        .popup-below.popup-align-left .leaflet-popup-content-wrapper {
            transform: translateY(calc(100% + 15px)) translateX(-40%);
        }

        /* Marker Highlight Glow */
        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 0 0 rgba(250, 179, 135, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(250, 179, 135, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(250, 179, 135, 0);
            }
        }

        .marker-highlight-glow {
            animation: pulse-glow 1.5s infinite;
            border: 2px solid #fab387 !important;
            /* Peach border */
            border-radius: 50%;
            z-index: 1000 !important;
        }
    </style>
</head>

<body class="flex flex-col h-screen overflow-hidden font-sans">

    <!-- Header -->
    <header
        class="h-16 bg-catppuccin-mantle border-b border-catppuccin-surface0 flex items-center justify-between px-6 z-30 relative">
        <div class="flex items-center gap-4">
            <h1
                class="text-xl font-bold bg-gradient-to-r from-catppuccin-blue to-catppuccin-lavender bg-clip-text text-transparent">
                Netmap BandRio</h1>

            <!-- Global Search -->
            <div class="relative ml-4">
                <input type="text" id="global-search" onkeyup="debounceSearch()" autocomplete="off"
                    placeholder="üîç Pesquisar em todo o mapa..."
                    class="bg-catppuccin-surface0 text-sm text-catppuccin-text px-3 py-1 rounded w-80 border border-catppuccin-surface1 focus:border-catppuccin-blue outline-none placeholder-catppuccin-overlay0 transition-all focus:w-96">
                <div id="search-results"
                    class="absolute top-9 left-0 w-full bg-catppuccin-mantle border border-catppuccin-surface0 rounded shadow-xl hidden max-h-80 overflow-y-auto z-50">
                </div>
            </div>

            <!-- Software Search (OCS) -->
            <div class="relative ml-4">
                <input type="text" id="software-search" onkeyup="debounceSoftwareSearch()" autocomplete="off"
                    placeholder="üíæ Software (OCS)..."
                    class="bg-catppuccin-surface0 text-sm text-catppuccin-text px-3 py-1 rounded w-64 border border-catppuccin-surface1 focus:border-catppuccin-peach outline-none placeholder-catppuccin-overlay0 transition-all focus:w-80">
            </div>
        </div>

        <div class="flex items-center gap-4">
            <button id="btn-floors" onclick="toggleSidebar()"
                class="text-sm bg-catppuccin-surface0 px-3 py-1 rounded hover:bg-catppuccin-surface1">Gerenciar
                Andares</button>
            <button id="btn-insert" onclick="toggleInsertMode()"
                class="text-sm bg-catppuccin-blue text-catppuccin-crust font-bold px-3 py-1 rounded hover:opacity-90">Inserir
                Item</button>
            <button id="btn-inventory" onclick="toggleRightSidebar()"
                class="text-sm bg-catppuccin-peach text-catppuccin-crust font-bold px-3 py-1 rounded hover:opacity-90">Invent√°rio
                Pendente</button>
            <button onclick="document.getElementById('export-modal').classList.remove('hidden')"
                class="text-sm bg-catppuccin-green text-catppuccin-crust font-bold px-3 py-1 rounded hover:opacity-90">
                Excel</button>
            <button id="btn-users" onclick="openUserModal()"
                class="hidden text-sm bg-catppuccin-mauve text-catppuccin-crust font-bold px-3 py-1 rounded hover:opacity-90">
                Usu√°rios</button>
            <button onclick="logout()"
                class="text-sm border border-catppuccin-red text-catppuccin-red px-3 py-1 rounded hover:bg-catppuccin-red hover:text-catppuccin-crust transition-colors">
                Sair
            </button>
        </div>
        <div id="connection-status" class="flex gap-2 text-xs">
            <span id="status-local" class="px-2 py-1 rounded bg-catppuccin-surface0 text-catppuccin-overlay0">Local:
                Connecting...</span>
            <span id="status-ocs" class="px-2 py-1 rounded bg-catppuccin-surface0 text-catppuccin-overlay0">OCS:
                Connecting...</span>
        </div>
    </header>

    <div class="flex flex-grow relative">
        <!-- Sidebar Left (Floor Manager) -->
        <aside id="sidebar"
            class="w-96 bg-catppuccin-mantle border-r border-catppuccin-surface0 hidden flex-col p-4 z-20 absolute h-full transition-transform left-0 top-0 pt-20">
            <h2 class="text-lg font-bold mb-4">Gerenciar Andares</h2>
            <div id="floor-list" class="space-y-2 mb-4 overflow-y-auto flex-grow"></div>
            <div class="border-t border-catppuccin-surface0 pt-4">
                <h3 class="text-sm font-bold mb-2">Upload Novo Andar</h3>
                <form id="upload-form" class="space-y-2 text-xs">
                    <input type="text" id="new-floor-name" placeholder="Nome (ex: T√©rreo)"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0 text-catppuccin-text">
                    <input type="number" id="new-floor-level" placeholder="Ordem (ex: 1)"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0 text-catppuccin-text">
                    <input type="file" id="new-floor-file" accept="image/*" class="w-full text-catppuccin-overlay0">
                    <button type="submit"
                        class="w-full bg-catppuccin-blue text-catppuccin-crust font-bold py-2 rounded hover:opacity-90">Upload</button>
                </form>
            </div>
        </aside>

        <!-- Sidebar Right (Pending Inventory) -->
        <aside id="sidebar-right"
            class="w-96 bg-catppuccin-mantle border-l border-catppuccin-surface0 hidden flex flex-col p-4 z-20 fixed bottom-0 right-0 top-14 pt-4 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 id="sidebar-right-title" class="text-lg font-bold text-catppuccin-peach">Invent√°rio Pendente <span
                        id="inventory-count" class="text-sm text-catppuccin-text opacity-75"></span></h2>
                <div class="flex gap-2">
                    <button id="btn-clear-audit" onclick="clearAudit()"
                        class="hidden text-xs text-catppuccin-red hover:text-white font-bold border border-catppuccin-red px-2 py-0.5 rounded">‚úñ
                        Limpar</button>
                    <button id="btn-refresh-inv" onclick="fetchAudit()"
                        class="text-xs text-catppuccin-blue hover:text-white">‚Üª Atualizar</button>
                </div>
            </div>

            <input type="text" id="search-ocs" onkeyup="filterOCSList()" placeholder="üîç Pesquisar M√°quina..."
                class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0 text-sm mb-2 text-catppuccin-text">

            <select id="audit-version-filter" onchange="filterAuditResults()"
                class="hidden w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0 text-sm mb-2 text-catppuccin-text cursor-pointer">
                <!-- Options injected by JS -->
            </select>

            <p class="text-xs text-catppuccin-overlay0 mb-4">Arraste para o mapa para posicionar.</p>
            <div id="inventory-list"
                class="space-y-2 overflow-y-auto flex-grow min-h-0 pb-20 scrollbar-thin scrollbar-thumb-catppuccin-surface1 scrollbar-track-catppuccin-base">
                <!-- Items will be injected here -->
                <div class="text-center text-catppuccin-overlay0 text-sm mt-10">Carregando...</div>
            </div>
        </aside>

        <!-- Hidden input for file replacement -->
        <input type="file" id="replace-file-input" accept="image/*" class="hidden">

        <!-- Insert/Edit Modal -->
        <div id="insert-modal"
            class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-catppuccin-mantle border border-catppuccin-surface0 p-6 rounded shadow-xl z-30 w-80">
            <h3 id="modal-title" class="text-lg font-bold mb-4 text-catppuccin-lavender">Inserir Item</h3>
            <form id="insert-form" class="space-y-3">
                <input type="hidden" id="insert-id">
                <input type="hidden" id="insert-x">
                <input type="hidden" id="insert-y">

                <div>
                    <label class="block text-xs text-catppuccin-overlay0 mb-1">Tipo</label>
                    <select id="insert-type"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0"
                        onchange="handleTypeChange()">
                        <option value="Computador">Computador</option>
                        <option value="Ponto">Ponto de Rede (Vazio)</option>
                        <option value="Ramal">Ramal</option>
                        <option value="Equipamento">Equipamento</option>
                        <option value="Texto">Texto / Anota√ß√£o</option>
                    </select>
                </div>

                <div id="field-name">
                    <label id="label-name" class="block text-xs text-catppuccin-overlay0 mb-1">Nome</label>
                    <input type="text" id="insert-name" placeholder="Nome do Item"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0">
                    <textarea id="insert-text-content" placeholder="Digite o texto..." rows="3"
                        class="hidden w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0"></textarea>
                </div>

                <div id="field-point">
                    <label class="block text-xs text-catppuccin-overlay0 mb-1">Ponto de Rede</label>
                    <input type="text" id="insert-point" placeholder="Ex: 160"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0">
                </div>

                <div id="field-responsible">
                    <label class="block text-xs text-catppuccin-overlay0 mb-1">Respons√°vel</label>
                    <input type="text" id="insert-assigned" placeholder="Nome do Respons√°vel"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0">
                </div>

                <div id="field-details" class="hidden">
                    <label class="block text-xs text-catppuccin-overlay0 mb-1">Detalhes</label>
                    <textarea id="insert-details" placeholder="Informa√ß√µes adicionais..." rows="2"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0"></textarea>
                </div>

                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" onclick="closeInsertModal()"
                        class="px-3 py-1 bg-catppuccin-surface0 rounded hover:bg-catppuccin-surface1">Cancelar</button>
                    <button type="submit" id="btn-save-modal"
                        class="px-3 py-1 bg-catppuccin-blue text-catppuccin-crust font-bold rounded hover:opacity-90">Salvar</button>
                </div>
            </form>
        </div>


        <!-- User Mgmt Modal -->
        <div id="user-modal"
            class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-catppuccin-mantle border border-catppuccin-surface0 p-6 rounded shadow-xl z-40 w-96 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-catppuccin-mauve">Gest√£o de Usu√°rios</h3>
                <button onclick="document.getElementById('user-modal').classList.add('hidden')"
                    class="text-catppuccin-red hover:text-white">‚úï</button>
            </div>

            <form id="create-user-form"
                class="space-y-2 mb-4 p-3 bg-catppuccin-surface0 rounded border border-catppuccin-surface1">
                <h4 class="text-xs font-bold text-catppuccin-text mb-2">Novo Usu√°rio</h4>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="new-username" placeholder="Login" required
                        class="bg-catppuccin-crust p-1.5 rounded text-xs border border-catppuccin-surface1 w-full text-catppuccin-text outline-none focus:border-catppuccin-mauve">
                    <input type="password" id="new-password" placeholder="Senha" required
                        class="bg-catppuccin-crust p-1.5 rounded text-xs border border-catppuccin-surface1 w-full text-catppuccin-text outline-none focus:border-catppuccin-mauve">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="new-fullname" placeholder="Nome Completo"
                        class="bg-catppuccin-crust p-1.5 rounded text-xs border border-catppuccin-surface1 w-full text-catppuccin-text outline-none focus:border-catppuccin-mauve">
                    <select id="new-role"
                        class="bg-catppuccin-crust p-1.5 rounded text-xs border border-catppuccin-surface1 w-full text-catppuccin-text outline-none">
                        <option value="viewer">Viewer (Leitura)</option>
                        <option value="admin">Admin (Total)</option>
                    </select>
                </div>
                <button type="submit"
                    class="w-full bg-catppuccin-mauve text-catppuccin-crust font-bold py-1.5 rounded text-xs hover:opacity-90">Criar
                    Usu√°rio</button>
            </form>

            <div class="flex-grow overflow-y-auto bg-catppuccin-crust rounded border border-catppuccin-surface0 p-1">
                <table class="w-full text-xs text-left">
                    <thead class="text-catppuccin-overlay0 border-b border-catppuccin-surface0">
                        <tr>
                            <th class="p-2">User</th>
                            <th class="p-2">Nome</th>
                            <th class="p-2">Role</th>
                        </tr>
                    </thead>
                    <tbody id="user-list-body" class="text-catppuccin-text"></tbody>
                </table>
            </div>
        </div>



        <!-- Export Modal -->
        <div id="export-modal"
            class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-catppuccin-mantle border border-catppuccin-surface0 p-6 rounded shadow-xl z-40 w-80">
            <h3 class="text-lg font-bold mb-4 text-catppuccin-green">Exportar Excel</h3>
            <div class="space-y-4">
                <div>
                    <h4 class="text-xs font-bold text-catppuccin-overlay0 mb-2">Tipos</h4>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-type" value="Computador"
                                checked> Computador</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-type" value="Ramal"
                                checked> Ramal</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-type" value="Ponto"
                                checked> Ponto</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-type"
                                value="Equipamento" checked> Equipamento</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-type" value="Texto"
                                checked> Texto</label>
                    </div>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-catppuccin-overlay0 mb-2">Colunas</h4>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-field" value="name"
                                checked> Nome</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-field" value="ip"
                                checked> IP (Netmap)</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-field" value="type"
                                checked> Tipo</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-field" value="ocs_cpu"
                                checked> OCS CPU</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-field" value="ocs_ram"
                                checked> OCS RAM</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-field" value="ocs_disk"
                                checked> OCS Disco</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-field" value="ocs_os"
                                checked> OCS OS</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-field" value="assigned"
                                checked> Resp.</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-field" value="details"
                                checked> Detalhes</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="exp-field" value="floor"
                                checked> Andar</label>
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-2">
                    <button onclick="document.getElementById('export-modal').classList.add('hidden')"
                        class="px-3 py-1 bg-catppuccin-surface0 rounded hover:bg-catppuccin-surface1 text-xs">Cancelar</button>
                    <button onclick="submitExport()"
                        class="px-3 py-1 bg-catppuccin-green text-catppuccin-crust font-bold rounded hover:opacity-90 text-xs text-catppuccin-base">Exportar</button>
                </div>
            </div>
        </div>

        <!-- Map -->
        <!-- Add dragover/drop handlers -->
        <main class="flex-grow relative w-full" ondrop="handleDrop(event)" ondragover="allowDrop(event)">
            <div id="map"></div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const map = L.map('map', { crs: L.CRS.Simple, minZoom: -3, maxZoom: 2, zoomSnap: 0.5 });
        let currentFloorId = null;
        let floorsData = [];
        // Layer Groups
        const layers = {
            "Computadores": L.layerGroup().addTo(map),
            "Ramais": L.layerGroup().addTo(map),
            "Pontos": L.layerGroup().addTo(map),
            "Equipamentos": L.layerGroup().addTo(map),
            "Textos": L.layerGroup().addTo(map)
        };

        const layerControl = L.control.layers(null, layers, { collapsed: false, position: 'topright' }).addTo(map);

        // Previous markersLayer usage replaced by these groups
        // const markersLayer = L.featureGroup().addTo(map); // Removed
        let allNodes = [];
        let floorToReplace = null;
        let isInsertMode = false;
        let insertMarker = null;

        async function init() {
            // AUTH CHECK
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/static/login.html';
                return;
            }

            // Setup Header with User Info & Logout
            let role = localStorage.getItem('role');
            // FIX: Fallback to user_role if role is missing (backward compatibility)
            if (!role) {
                const legacyRole = localStorage.getItem('user_role');
                if (legacyRole) {
                    role = legacyRole;
                    localStorage.setItem('role', legacyRole);
                } else {
                    role = 'viewer';
                }
            }

            // PERMISSIONS
            // PERMISSIONS
            // Admin: All access
            // Editor: Floors, Insert, Inventory (No Users)
            // Viewer: Read Only
            document.getElementById('btn-users').classList.add('hidden');
            document.getElementById('btn-floors').classList.add('hidden');
            document.getElementById('btn-insert').classList.add('hidden');
            document.getElementById('btn-inventory').classList.add('hidden');

            if (role === 'admin') {
                document.getElementById('btn-users').classList.remove('hidden');
                document.getElementById('btn-floors').classList.remove('hidden');
                document.getElementById('btn-insert').classList.remove('hidden');
                document.getElementById('btn-inventory').classList.remove('hidden');
            } else if (role === 'editor') {
                document.getElementById('btn-floors').classList.remove('hidden');
                document.getElementById('btn-insert').classList.remove('hidden');
                document.getElementById('btn-inventory').classList.remove('hidden');
            }

            await fetchFloors();
            await fetchNodes();
            await fetchStatusMap();
            checkConnection();
            fetchAudit();
            setInterval(checkConnection, 30000);
            setInterval(fetchStatusMap, 60000);
        }

        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/static/login.html';
                return;
            }

            const headers = {
                'Authorization': `Bearer ${token}`,
                ...options.headers
            };

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401 || response.status === 403) {
                logout();
                return;
            }

            return response;
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('role');
            localStorage.removeItem('full_name');
            window.location.href = '/static/login.html';
        }

        let floorLayers = {};

        async function fetchFloors() {
            try {
                const res = await fetchWithAuth('/api/floors');
                floorsData = await res.json();

                if (floorsData.length === 0) {
                    // No Floors Warning
                    alert("Bem-vindo! Nenhum andar encontrado.\nClique em 'Gerenciar Andares' para come√ßar.");
                    toggleSidebar();
                }

                layerControl.remove();
                // Re-add control with Overlays (layers) preserved
                const newControl = L.control.layers(null, layers, { collapsed: false, position: 'topright' }).addTo(map);
                const sidebarList = document.getElementById('floor-list');
                sidebarList.innerHTML = '';
                floorLayers = {};
                floorsData.forEach((floor, index) => {
                    const bounds = [[0, 0], [floor.height, floor.width]];
                    const layer = L.imageOverlay(floor.image_path, bounds);
                    floorLayers[floor.id] = layer;
                    newControl.addBaseLayer(layer, floor.name);
                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center bg-catppuccin-surface0 p-2 rounded text-sm";
                    item.innerHTML = `<div><div class='font-bold'>${floor.name}</div><div class='text-xs text-catppuccin-overlay0'>Lvl ${floor.level_order}</div></div><div class="flex gap-2"><button onclick="triggerReplace(${floor.id})" class="hover:text-catppuccin-blue">‚ôªÔ∏è</button><button onclick="deleteFloor(${floor.id})" class="hover:text-catppuccin-red">üóëÔ∏è</button></div>`;
                    sidebarList.appendChild(item);
                    if (index === 0 && !currentFloorId) {
                        layer.addTo(map);
                        // Pad bounds by 500px to allow panning past edges
                        const paddedBounds = [[-500, -500], [floor.height + 500, floor.width + 500]];
                        map.setMaxBounds(paddedBounds);
                        map.fitBounds(bounds);
                        currentFloorId = floor.id;
                    }
                });
            } catch (e) { console.error(e); }
        }

        async function fetchNodes() {
            try { const res = await fetchWithAuth('/api/nodes'); const data = await res.json(); allNodes = data.features; updateMarkers(); } catch (e) { }
        }

        // DRAG AND DROP LOGIC
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function filterOCSList() {
            const input = document.getElementById('search-ocs');
            const filter = input.value.toUpperCase();
            const list = document.getElementById("inventory-list");
            const items = list.getElementsByClassName('draggable-item');

            for (let i = 0; i < items.length; i++) {
                const txtValue = items[i].innerText || items[i].textContent;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    items[i].style.display = "";
                } else {
                    items[i].style.display = "none";
                }
            }
        }

        function drag(ev, name) {
            ev.dataTransfer.setData("machineName", name);
        }

        async function handleDrop(ev) {
            ev.preventDefault();
            if (!currentFloorId) return alert("Selecione um andar primeiro!");

            const machineName = ev.dataTransfer.getData("machineName");
            if (!machineName) return;

            // Calculate Map Coordinates from Drop Event
            // map.mouseEventToLatLng requires a MouseEvent. 'ev' is a DragEvent which inherits from MouseEvent but we rely on Leaflet.
            // Leaflet map container relative position calculation:
            const containerPoint = map.mouseEventToContainerPoint(ev);
            const latLng = map.containerPointToLatLng(containerPoint);

            // Auto-Save Node
            // We assume it's type 'Computador' since it came from Inventory list
            const payload = {
                name: machineName,
                type: 'Computador',
                point_number: null,
                floor_id: currentFloorId,
                x: latLng.lng, // X is Lng (Width)
                y: latLng.lat  // Y is Lat (Height)
            };

            if (confirm(`Adicionar ${machineName} nesta posi√ß√£o?`)) {
                try {
                    const res = await fetchWithAuth('/api/nodes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (res.ok) {
                        fetchNodes(); // Refresh map
                        fetchAudit(); // Refresh sidebar (should remove item)
                    } else {
                        alert("Erro ao salvar item.");
                    }
                } catch (e) {
                    alert("Erro de conex√£o.");
                }
            }
        }

        async function fetchAudit() {
            const container = document.getElementById('inventory-list');
            try {
                const res = await fetchWithAuth('/api/inventory/audit');
                const data = await res.json();

                if (data.error) {
                    container.innerHTML = `<div class="text-red-400 text-xs p-2">${data.error}</div>`;
                    return;
                }

                container.innerHTML = '';
                const missingInMap = data.missing_in_map || [];

                // Update Count
                const countEl = document.getElementById('inventory-count');
                if (countEl) countEl.innerText = `(${missingInMap.length})`;

                if (missingInMap.length === 0) {
                    container.innerHTML = `<div class="text-catppuccin-green text-xs p-2">Tudo sincronizado!</div>`;
                    return;
                }

                missingInMap.forEach(item => {
                    const div = document.createElement('div');
                    // Add red border to indicate "Pending/Missing"
                    div.className = "bg-catppuccin-surface0 p-2 rounded text-sm flex justify-between items-center draggable-item hover:bg-catppuccin-surface1 transition-colors border-l-4 border-catppuccin-red";
                    div.draggable = true;
                    div.ondragstart = (ev) => drag(ev, item.name);

                    // Tooltip with hardware details
                    const details = `Model: ${item.model || 'N/A'}\nCPU: ${item.processor || 'N/A'}\nRAM: ${item.memory || 'N/A'}`;
                    div.title = details;

                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-catppuccin-text">üñ•Ô∏è ${item.name}</div>
                            <div class="text-[10px] text-catppuccin-overlay0">${item.tag || 'Sem TAG'}</div>
                            <div class="text-[9px] text-catppuccin-overlay0">${item.model ? item.model.substring(0, 15) : ''}</div>
                        </div>
                        <div class="text-catppuccin-peach">‚ãÆ</div>
                    `;
                    container.appendChild(div);
                });

            } catch (e) {
                container.innerHTML = `<div class="text-red-400 text-xs p-2">Erro ao carregar auditoria.</div>`;
            }
        }

        async function fetchOCSData(hostname, container) {
            try {
                container.innerHTML = "<span class='text-xs text-catppuccin-overlay0 animate-pulse'>Buscando OCS...</span>";
                const res = await fetchWithAuth(`/api/ocs/machine/${hostname}`);
                if (res.ok) {
                    const data = await res.json();

                    // Domain Badge Logic
                    // Prioritize detecting "BANDEIRANTES" or "bandeirantes.com.br" in WORKGROUP
                    const wg = (data.WORKGROUP || '').toUpperCase();
                    const isDomain = wg.includes('BANDEIRANTES');
                    const domainBadge = isDomain
                        ? `<span class="bg-catppuccin-green text-catppuccin-crust px-2 py-0.5 rounded text-[10px] font-bold block w-fit">DOM√çNIO OK</span>`
                        : `<span class="bg-catppuccin-peach text-catppuccin-crust px-2 py-0.5 rounded text-[10px] font-bold block w-fit">WORKGROUP: ${data.WORKGROUP || 'N/A'}</span>`;

                    // Software List
                    let softListHtml = '';
                    if (data.softwares && data.softwares.length > 0) {
                        softListHtml = `<div class="mt-2 border-t border-catppuccin-surface1 pt-1">
                            <p class="font-bold text-[10px] text-catppuccin-mavue mb-1">Top Softwares OCS</p>
                            <ul class="list-disc pl-3 text-[9px] text-catppuccin-text">
                                ${data.softwares.map(s => `<li>${s.NAME} <span class="opacity-50">(${s.VERSION})</span></li>`).join('')}
                            </ul>
                        </div>`;
                    }

                    container.innerHTML = `
                        <div class="bg-catppuccin-surface0 p-2 rounded mt-2 text-xs">
                            <div class="mb-2">
                                <p class="font-bold text-catppuccin-green mb-1">‚úì Sincronizado</p>
                                ${domainBadge}
                            </div>
                            <p>OS: ${data.OSNAME || 'N/A'}</p>
                            <p>IP: ${data.IPADDR || 'N/A'}</p>
                            <p>CPU: ${data.PROCESSOR || 'N/A'}</p>
                            <p>RAM: ${data.MEMORY ? data.MEMORY + ' MB' : 'N/A'}</p>
                            <p>Disk: ${data.DISKSIZE ? (data.DISKSIZE / 1024).toFixed(1) + ' GB' : 'N/A'}</p>
                            <p>User: ${data.USERID || 'N/A'}</p>
                            <p>Last: ${data.LASTDATE || 'N/A'}</p>
                            ${softListHtml}
                        </div>
                    `;
                } else {
                    container.innerHTML = "<span class='text-xs text-gray-500'>Sem dados no OCS</span>";
                }
            } catch (e) {
                container.innerHTML = "<span class='text-xs text-red-400'>Erro OCS</span>";
            }
        }

        // Global status map
        let nodeStatusMap = {};

        async function fetchStatusMap() {
            try {
                const res = await fetchWithAuth('/api/inventory/status');
                if (res.ok) {
                    nodeStatusMap = await res.json();
                    updateMarkers(); // Refresh colors
                }
            } catch (e) { console.error("Status fetch failed", e); }
        }

        function updateMarkers() {
            if (!currentFloorId) return;
            // Clear all layers
            Object.values(layers).forEach(l => l.clearLayers());

            const floorNodes = allNodes.filter(n => n.properties.floor_id === currentFloorId);
            // const statusMap = getStatusMap(); // Assume this gets latest status // This line was not defined, using nodeStatusMap

            floorNodes.forEach(f => {
                const type = f.properties.type;
                const id = f.id; // Correct ID access
                const [y, x] = f.geometry.coordinates;

                let colorClass = "";
                let colorHex = "#a6e3a1"; // Default
                let tooltipContent = "";

                // Determine Layer Group
                let targetLayer = layers["Computadores"];
                if (type === 'Ramal') targetLayer = layers["Ramais"];
                else if (type === 'Ponto') targetLayer = layers["Pontos"];
                else if (type === 'Equipamento') targetLayer = layers["Equipamentos"];
                else if (type === 'Texto') targetLayer = layers["Textos"];

                // Determine Color & Content (Logic preserved)
                if (type === 'Computador') {
                    const status = nodeStatusMap[id];
                    if (status === 'red') {
                        colorClass = "nm-tooltip-red"; colorHex = "#f38ba8";
                        if (!tooltipContent.includes("‚ö†Ô∏è")) tooltipContent = "‚ö†Ô∏è ";
                    } else if (status === 'gray') {
                        colorClass = "nm-tooltip-gray"; colorHex = "#6c7086";
                    } else {
                        colorClass = "nm-tooltip-green"; colorHex = "#a6e3a1";
                    }
                } else if (type === 'Ponto') {
                    colorClass = "nm-tooltip-yellow"; colorHex = "#f9e2af";
                } else if (type === 'Ramal') {
                    colorClass = "nm-tooltip-mauve"; colorHex = "#cba6f7";
                } else if (type === 'Equipamento') {
                    colorClass = "nm-tooltip-blue"; colorHex = "#89b4fa";
                } else if (type === 'Texto') {
                    colorClass = "nm-tooltip-text"; colorHex = "transparent";
                }

                if (type === 'Ponto') {
                    tooltipContent = `P: ${f.properties.point_number || '?'}`;
                } else if (type === 'Ramal') {
                    tooltipContent = `${f.properties.name}`;
                } else if (type === 'Equipamento') {
                    tooltipContent = `<span class="font-bold">${f.properties.name}</span>`;
                    if (f.properties.point_number) tooltipContent += `<br><span class="opacity-75">P: ${f.properties.point_number}</span>`;
                } else if (type === 'Texto') {
                    tooltipContent = `<span class="text-sm font-bold text-catppuccin-text" style="text-shadow: 1px 1px 2px black;">${f.properties.name}</span>`;
                } else {
                    tooltipContent += `<span class="font-bold">${f.properties.name}</span>`;
                    if (f.properties.point_number) tooltipContent += `<br><span class="opacity-75">P: ${f.properties.point_number}</span>`;
                }

                const marker = L.circleMarker([x, y], {
                    radius: type === 'Texto' ? 0 : 4,
                    fillColor: colorHex,
                    color: type === 'Texto' ? "transparent" : "#11111b",
                    weight: 1,
                    fillOpacity: 0.9
                }).addTo(targetLayer); // Add to specific layer

                marker.nodeId = id;
                marker.feature = f; // REQUIRED for search/highlight logic

                marker.bindTooltip(tooltipContent, {
                    permanent: true,
                    interactive: true,
                    direction: 'center',
                    className: type === 'Texto' ? "leaflet-tooltip nm-tooltip-text" : `nm-tooltip ${colorClass}`,
                    offset: type === 'Texto' ? [0, 0] : [0, -4]
                });

                // Context Menu for Edit (Right Click or Click)
                // if (type === 'Texto') return; 

                const popupDiv = document.createElement('div');
                popupDiv.className = "flex flex-col gap-2 min-w-[150px]";
                popupDiv.innerHTML = `<p class="font-bold border-b border-gray-600 pb-1">${f.properties.name}</p>`;

                // Show Responsible or Details
                if (f.properties.assigned_to && type !== 'Equipamento') {
                    if (type === 'Ramal') {
                        popupDiv.innerHTML += `<p class="text-sm font-bold text-catppuccin-peach mt-1">üë§ ${f.properties.assigned_to}</p>`;
                    } else {
                        popupDiv.innerHTML += `<p class="text-[10px] text-catppuccin-overlay0 mt-1">üë§ ${f.properties.assigned_to}</p>`;
                    }
                }

                if (f.properties.details) {
                    // Equipment Details Highlight
                    if (type === 'Equipamento') {
                        popupDiv.innerHTML += `<div class="mt-2 p-2 bg-catppuccin-base rounded border border-catppuccin-blue">
                            <p class="text-[10px] text-catppuccin-subtext0 uppercase font-bold">Detalhes</p>
                            <p class="text-sm text-catppuccin-text">${f.properties.details}</p>
                         </div>`;
                    } else {
                        popupDiv.innerHTML += `<p class="text-xs text-catppuccin-text mt-1 bg-catppuccin-surface0 p-1 rounded italic">${f.properties.details}</p>`;
                    }
                }

                // Alert Message
                if (type === 'Computador' && nodeStatusMap[id] === 'red') {
                    popupDiv.innerHTML += `<p class="text-xs text-catppuccin-red font-bold animate-pulse">‚ö†Ô∏è N√£o encontrado no OCS</p>`;
                }

                const role = localStorage.getItem('role') || 'viewer';
                if (role === 'admin' || role === 'editor') {
                    const btnEdit = document.createElement('button');
                    btnEdit.innerText = "‚úèÔ∏è Editar";
                    btnEdit.className = "text-xs bg-catppuccin-blue text-catppuccin-crust px-2 py-1 rounded hover:opacity-80 mt-1 w-full";
                    btnEdit.onclick = () => openEditModal(f);
                    popupDiv.appendChild(btnEdit);

                    const delBtn = document.createElement('button');
                    delBtn.className = "text-xs text-red-400 hover:text-red-300 w-full text-left mt-1 border-t border-catppuccin-surface0 pt-1";
                    delBtn.innerText = "üóëÔ∏è Remover Item";
                    delBtn.onclick = () => deleteNode(f.id);
                    popupDiv.appendChild(delBtn);
                }

                // OCS Section
                const ocsDiv = document.createElement('div');
                ocsDiv.id = `ocs-${id}`;
                popupDiv.appendChild(ocsDiv);

                // marker.bindPopup(popupDiv); // Removed static binding

                // Dynamic Popup Positioning Logic
                marker.on('click', (e) => {
                    // Calculate position relative to map container
                    const containerPoint = map.latLngToContainerPoint(e.latlng);
                    const mapSize = map.getSize();

                    const isNearTop = containerPoint.y < 300;
                    const isNearLeft = containerPoint.x < 150;
                    const isNearRight = containerPoint.x > (mapSize.x - 150);

                    let className = '';
                    if (isNearTop) className += 'popup-below ';
                    if (isNearLeft) className += 'popup-align-right '; // If near left, push right
                    if (isNearRight) className += 'popup-align-left '; // If near right, push left

                    const options = {
                        className: className.trim(),
                        offset: isNearTop ? [0, 5] : [0, 0]
                    };

                    const popup = L.popup(options)
                        .setLatLng(e.latlng)
                        .setContent(popupDiv);

                    // Attach OCS fetcher
                    if (f.properties.type === 'Computador') {
                        fetchOCSData(f.properties.name, ocsDiv);
                    }

                    marker.bindPopup(popup).openPopup();
                });
            });
        }

        // Search Logic
        let searchTimeout = null;
        function debounceSearch() {
            const q = document.getElementById('global-search').value;
            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => searchNodes(q), 300);
        }

        async function searchNodes(q) {
            const resContainer = document.getElementById('search-results');
            if (!q || q.length < 2) {
                resContainer.classList.add('hidden');
                return;
            }
            try {
                const res = await fetchWithAuth(`/api/search?q=${encodeURIComponent(q)}`);
                const items = await res.json();
                renderSearchResults(items);
            } catch (e) { console.error(e); }
        }

        // Software Search Logic - Audit Panel
        let softSearchTimeout = null;
        function debounceSoftwareSearch() {
            const q = document.getElementById('software-search').value;
            if (softSearchTimeout) clearTimeout(softSearchTimeout);
            softSearchTimeout = setTimeout(() => searchSoftware(q), 800);
        }

        async function searchSoftware(q) {
            if (!q || q.length < 3) {
                if (q.length === 0) clearAudit();
                return;
            }
            console.log(`[DEBUG] Searching for software: ${q}`);
            try {
                const res = await fetchWithAuth(`/api/ocs/software/search?q=${encodeURIComponent(q)}`);
                if (res.ok) {
                    const results = await res.json();
                    console.log("[DEBUG] API returned:", results);

                    // switch sidebar mode
                    enterAuditMode(results);
                    highlightSoftwareMachines(results);
                } else {
                    console.error("[DEBUG] API Error:", res.status);
                }
            } catch (e) { console.error(e); }
        }

        // Audit Mode Variables
        let isAuditMode = false;
        let highlightedMarkers = [];
        let currentAuditResults = []; // Store original results

        function clearHighlights() {
            if (!highlightedMarkers) return;
            highlightedMarkers.forEach(m => {
                const el = m.getElement();
                if (el) {
                    L.DomUtil.removeClass(el, 'highlight-pulse');
                    L.DomUtil.removeClass(el, 'marker-highlight-glow');
                }
            });
            highlightedMarkers = [];
        }

        function enterAuditMode(results) {
            isAuditMode = true;
            currentAuditResults = results; // Save for filtering

            document.getElementById('sidebar-right').classList.remove('hidden');
            document.getElementById('sidebar-right-title').innerHTML = `Auditoria (${results.length})`;
            document.getElementById('sidebar-right-title').className = "text-lg font-bold text-catppuccin-yellow";

            document.getElementById('inventory-list').innerHTML = '';
            document.getElementById('btn-refresh-inv').classList.add('hidden');
            document.getElementById('btn-clear-audit').classList.remove('hidden');

            // Hide inventory search, Show Version Filter
            document.getElementById('search-ocs').classList.add('hidden');
            const filterSelect = document.getElementById('audit-version-filter');
            filterSelect.classList.remove('hidden');

            // Populate Filter
            const versions = [...new Set(results.map(r => r.version || 'Desconhecido'))].sort();
            filterSelect.innerHTML = `<option value="">Todas as Vers√µes (${versions.length})</option>`;
            versions.forEach(v => {
                const count = results.filter(r => (r.version || 'Desconhecido') === v).length;
                filterSelect.innerHTML += `<option value="${v}">${v} (${count})</option>`;
            });

            renderAuditList(results);
        }

        function filterAuditResults() {
            const version = document.getElementById('audit-version-filter').value;
            let filtered = currentAuditResults;

            if (version) {
                filtered = currentAuditResults.filter(r => (r.version || 'Desconhecido') === version);
            }

            // Update Title Count
            document.getElementById('sidebar-right-title').innerHTML = `Auditoria (${filtered.length})`;

            renderAuditList(filtered);
            highlightSoftwareMachines(filtered);
        }

        function renderAuditList(list) {
            const container = document.getElementById('inventory-list');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = `<div class="text-catppuccin-overlay0 text-sm p-4 text-center">Nenhum resultado filtrado.</div>`;
                return;
            }

            list.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-catppuccin-surface0 p-2 rounded text-sm flex items-center justify-between hover:bg-catppuccin-surface1 transition-colors cursor-pointer border-l-4 border-catppuccin-yellow mb-2";
                div.onclick = () => focusOnMachine(item.hostname);
                div.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <span class="text-lg">üñ•Ô∏è</span>
                        <div class="font-bold text-catppuccin-text truncate" title="${item.hostname}">${item.hostname}</div>
                    </div>
                    <div class="text-xs text-catppuccin-yellow font-mono whitespace-nowrap pl-2">
                        v. ${item.version || '?'}
                    </div>
                `;
                container.appendChild(div);
            });
        }


        function clearAudit() {
            isAuditMode = false;
            document.getElementById('sidebar-right-title').innerHTML = `Invent√°rio Pendente <span id="inventory-count" class="text-sm text-catppuccin-text opacity-75"></span>`;
            document.getElementById('sidebar-right-title').className = "text-lg font-bold text-catppuccin-peach";
            document.getElementById('btn-refresh-inv').classList.remove('hidden');
            document.getElementById('btn-clear-audit').classList.add('hidden');
            document.getElementById('search-ocs').classList.remove('hidden');
            document.getElementById('software-search').value = '';

            clearHighlights();
            fetchAudit();
        }

        async function focusOnMachine(hostname) {
            const targetName = hostname.trim().toUpperCase();

            // Find node in allNodes to ensure we can switch floors if needed
            const node = allNodes.find(n => n.properties.name.toUpperCase() === targetName);

            if (node) {
                await goToNode(node);

                // Add Glow Effect after moving
                setTimeout(() => {
                    Object.values(layers).forEach(layerGroup => {
                        layerGroup.eachLayer(layer => {
                            if (layer.nodeId === node.id) {
                                const el = layer.getElement();
                                if (el) {
                                    L.DomUtil.addClass(el, 'marker-highlight-glow');
                                    highlightedMarkers.push(layer);

                                    // Remove glow after 5 seconds automatically
                                    setTimeout(() => {
                                        L.DomUtil.removeClass(el, 'marker-highlight-glow');
                                    }, 5000);
                                }
                            }
                        });
                    });
                }, 1800); // Wait for flyTo + popup delay
            } else {
                alert("Esta m√°quina n√£o est√° no mapa (pode estar no invent√°rio pendente ou n√£o cadastrada).");
            }
        }

        function highlightSoftwareMachines(results) {
            clearHighlights();
            let count = 0;
            const targetNames = results.map(r => r.hostname.trim().toUpperCase());

            Object.values(layers).forEach(layerGroup => {
                layerGroup.eachLayer(layer => {
                    if (layer.feature && layer.feature.properties.name) {
                        const markerName = layer.feature.properties.name.trim().toUpperCase();

                        if (targetNames.includes(markerName)) {
                            const el = layer.getElement();
                            if (el) {
                                L.DomUtil.addClass(el, 'marker-highlight-glow');
                                highlightedMarkers.push(layer);
                                count++;
                            }
                        }
                    }
                });
            });

            if (count === 0 && results.length > 0) {
                console.log("No matches on map for these results.");
            }
        }

        function renderSearchResults(items) {
            const resContainer = document.getElementById('search-results');
            resContainer.innerHTML = '';
            if (items.length === 0) {
                resContainer.innerHTML = '<div class="p-2 text-xs text-catppuccin-overlay0">Nenhum resultado.</div>';
            } else {
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "p-2 border-b border-catppuccin-surface0 hover:bg-catppuccin-surface0 cursor-pointer text-xs flex justify-between group";
                    div.onclick = () => goToNode(item);
                    div.innerHTML = `
            <div>
                            <div class="font-bold text-catppuccin-text group-hover:text-catppuccin-blue">${item.properties.name}</div>
                            <div class="text-[10px] text-catppuccin-overlay0">${item.properties.assigned_to ? 'üë§ ' + item.properties.assigned_to : 'Sem dono'}</div>
                        </div>
            <div class="text-catppuccin-overlay0 text-[10px] self-end">Lvl ${item.properties.floor_id}</div>
        `;
                    resContainer.appendChild(div);
                });
            }
            resContainer.classList.remove('hidden');
        }

        window.onkeydown = function (e) {
            if (e.key === 'Escape') {
                if (isInsertMode) toggleInsertMode();
                document.getElementById('search-results').classList.add('hidden');
                document.getElementById('insert-modal').classList.add('hidden');
                document.getElementById('user-modal').classList.add('hidden');
                document.getElementById('export-modal').classList.add('hidden');
            }
        }

        window.onclick = function (e) {
            const comp = document.getElementById('search-results');
            const input = document.getElementById('global-search');
            if (comp && e.target !== comp && e.target !== input && !comp.contains(e.target)) {
                comp.classList.add('hidden');
            }
        }

        async function goToNode(item) {
            document.getElementById('search-results').classList.add('hidden');
            const targetId = item.id;
            const targetFloor = item.properties.floor_id;

            if (currentFloorId !== targetFloor) {
                if (currentFloorId && floorLayers[currentFloorId]) {
                    map.removeLayer(floorLayers[currentFloorId]);
                }
                currentFloorId = targetFloor;
                const newLayer = floorLayers[currentFloorId];
                if (newLayer) {
                    newLayer.addTo(map);
                    const f = floorsData.find(x => x.id === currentFloorId);
                    if (f) {
                        const paddedBounds = [[-500, -500], [f.height + 500, f.width + 500]];
                        map.setMaxBounds(paddedBounds);
                        map.fitBounds([[0, 0], [f.height, f.width]]);
                    }
                }
                updateMarkers();
            }

            // AUTO-VISIBILITY LOGIC
            const type = item.properties.type;
            let targetGroup = null;
            if (type === 'Computador') targetGroup = layers["Computadores"];
            else if (type === 'Ramal') targetGroup = layers["Ramais"];
            else if (type === 'Ponto') targetGroup = layers["Pontos"];
            else if (type === 'Equipamento') targetGroup = layers["Equipamentos"];
            else if (type === 'Texto') targetGroup = layers["Textos"];

            if (targetGroup && !map.hasLayer(targetGroup)) {
                map.addLayer(targetGroup);
                console.log(`Auto - enabled layer for ${type}`);
            }

            const [y, x] = item.geometry.coordinates;
            map.flyTo([x, y], 1, { duration: 1.5 });

            setTimeout(() => {
                // Find and open popup in the correct layer group
                if (targetGroup) {
                    targetGroup.eachLayer(layer => {
                        if (layer.nodeId === targetId) {
                            layer.openPopup();
                        }
                    });
                }
            }, 1600);
        }
        function openUserModal() {
            document.getElementById('user-modal').classList.remove('hidden');
            fetchUsersList();
        }

        async function fetchUsersList() {
            const tbody = document.getElementById('user-list-body');
            tbody.innerHTML = '<tr><td colspan="3" class="p-2 text-center text-catppuccin-overlay0">Carregando...</td></tr>';
            try {
                const res = await fetchWithAuth('/api/users');
                if (res.ok) {
                    const users = await res.json();
                    tbody.innerHTML = '';
                    users.forEach(u => {
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-catppuccin-surface0 hover:bg-catppuccin-surface0";
                        tr.innerHTML = `<td class="p-2 font-bold">${u.username}</td><td class="p-2">${u.full_name || '-'}</td><td class="p-2"><span class="${u.role === 'admin' ? 'text-catppuccin-red border border-catppuccin-red px-1 rounded text-[10px]' : 'text-catppuccin-blue border border-catppuccin-blue px-1 rounded text-[10px]'}">${u.role.toUpperCase()}</span></td>`;
                        tbody.appendChild(tr);
                    });
                }
            } catch (e) { console.error(e); }
        }

        document.getElementById('create-user-form').addEventListener('submit', async e => {
            e.preventDefault();
            const u = document.getElementById('new-username').value;
            const p = document.getElementById('new-password').value;
            const f = document.getElementById('new-fullname').value;
            const r = document.getElementById('new-role').value;

            try {
                const res = await fetchWithAuth('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p, role: r, full_name: f })
                });
                if (res.ok) {
                    document.getElementById('create-user-form').reset();
                    fetchUsersList();
                } else {
                    const err = await res.json();
                    alert("Erro: " + (err.detail || "Falha ao criar"));
                }
            } catch (e) { alert("Erro conex√£o"); }
        });

        function toggleInsertMode() { closeInsertModal(); isInsertMode = !isInsertMode; document.getElementById('btn-insert').classList.toggle('bg-catppuccin-red', isInsertMode); document.getElementById('map').classList.toggle('cursor-crosshair', isInsertMode); document.getElementById('btn-insert').innerText = isInsertMode ? "Cancelar Inser√ß√£o" : "Inserir Item"; }
        function closeInsertModal() { document.getElementById('insert-modal').classList.add('hidden'); if (insertMarker) { map.removeLayer(insertMarker); insertMarker = null; } resetForm(); }
        function resetForm() { document.getElementById('insert-id').value = ''; document.getElementById('insert-form').reset(); document.getElementById('modal-title').innerText = "Inserir Item"; document.getElementById('btn-save-modal').innerText = "Salvar"; }
        function openEditModal(f) {
            map.closePopup();
            document.getElementById('insert-id').value = f.id;
            document.getElementById('insert-type').value = f.properties.type;
            if (f.properties.type === 'Ponto') {
                document.getElementById('insert-point').value = f.properties.point_number;
            } else {
                document.getElementById('insert-name').value = f.properties.name;
                document.getElementById('insert-text-content').value = f.properties.name; // Populate text area too
                document.getElementById('insert-point').value = f.properties.point_number || '';
            }
            document.getElementById('insert-assigned').value = f.properties.assigned_to || '';
            document.getElementById('insert-details').value = f.properties.details || ''; // Load Details

            const [y, x] = f.geometry.coordinates;
            document.getElementById('insert-x').value = x;
            document.getElementById('insert-y').value = y;
            handleTypeChange();
            document.getElementById('modal-title').innerText = "Editar Item";
            document.getElementById('btn-save-modal').innerText = "Atualizar";
            document.getElementById('insert-modal').classList.remove('hidden');
        }
        function handleTypeChange() {
            const t = document.getElementById('insert-type').value;
            const nd = document.getElementById('field-name');
            const pd = document.getElementById('field-point');
            const ln = document.getElementById('label-name');
            const rd = document.getElementById('field-responsible');
            const dd = document.getElementById('field-details');
            const inputName = document.getElementById('insert-name');

            // Reset visibilities
            nd.classList.remove('hidden');
            pd.classList.remove('hidden');
            rd.classList.remove('hidden');
            dd.classList.add('hidden');
            ln.innerText = "Nome";
            inputName.placeholder = "Nome do Item";

            if (t === 'Ponto') {
                nd.classList.add('hidden');
            } else if (t === 'Ramal') {
                ln.innerText = "N√∫mero do Ramal";
                inputName.placeholder = "Ex.: 123"; // Ramal Placeholder
                pd.classList.add('hidden');
            } else if (t === 'Computador') {
                rd.classList.add('hidden'); // Hide Responsible for Computer
            } else if (t === 'Equipamento') {
                rd.classList.add('hidden'); // Hide Responsible
                dd.classList.remove('hidden'); // Show Details
            } else if (t === 'Texto') {
                ln.innerText = "Conte√∫do";
                inputName.classList.add('hidden'); // Hide input
                document.getElementById('insert-text-content').classList.remove('hidden'); // Show textarea
                pd.classList.add('hidden');
                rd.classList.add('hidden');
            } else {
                // Default reset for switching back from Texto
                inputName.classList.remove('hidden');
                document.getElementById('insert-text-content').classList.add('hidden');
            }
        }
        document.getElementById('insert-form').addEventListener('submit', async e => {
            e.preventDefault();
            if (!currentFloorId) return alert("Selecione um andar!");

            const id = document.getElementById('insert-id').value;
            const t = document.getElementById('insert-type').value;
            let n = document.getElementById('insert-name').value.trim();
            const p = document.getElementById('insert-point').value.trim();
            const a = document.getElementById('insert-assigned').value.trim();
            const d = document.getElementById('insert-details').value.trim();
            const x = parseFloat(document.getElementById('insert-x').value);
            const y = parseFloat(document.getElementById('insert-y').value);

            // Special handling for types
            if (t === 'Texto') {
                n = document.getElementById('insert-text-content').value.trim();
                if (!n) return alert("O texto n√£o pode estar vazio.");
            } else if (t === 'Ponto') {
                n = `Ponto ${p}`;
            } else {
                // For Computer, Equipment, Branch - Name is mandatory
                if (!n) return alert("Por favor, preencha o campo Nome.");
            }

            const pay = {
                name: n,
                type: t,
                point_number: p || null,
                assigned_to: a || null,
                details: d || null,
                floor_id: currentFloorId
            };

            // Determine URL and Method
            let url = '/api/nodes';
            let method = 'POST';

            if (id) {
                url += `/${id}`;
                method = 'PUT';
            } else {
                pay.x = x;
                pay.y = y;
            }

            try {
                await fetchWithAuth(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pay)
                });

                closeInsertModal();
                if (isInsertMode) toggleInsertMode();
                fetchNodes();
                fetchAudit();
            } catch (e) {
                console.error(e);
                alert("Erro ao salvar item.");
            }
        });
        async function deleteNode(id) {
            if (confirm("Remover?")) {
                try {
                    await fetchWithAuth(`/api/nodes/${id}`, { method: 'DELETE' });
                    fetchNodes();
                    fetchAudit();
                } catch (e) { console.error(e); }
            }
        }

        map.on('click', e => {
            if (!isInsertMode) return;
            resetForm();
            if (insertMarker) map.removeLayer(insertMarker);
            insertMarker = L.circleMarker(e.latlng, { radius: 6, color: 'white' }).addTo(map);
            document.getElementById('insert-modal').classList.remove('hidden');
            document.getElementById('insert-x').value = e.latlng.lng.toFixed(2);
            document.getElementById('insert-y').value = e.latlng.lat.toFixed(2);
            handleTypeChange();
        });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('hidden');
            document.getElementById('sidebar').classList.toggle('flex');
        }

        function toggleRightSidebar() {
            document.getElementById('sidebar-right').classList.toggle('hidden');
            document.getElementById('sidebar-right').classList.toggle('flex');
        }

        async function deleteFloor(id) {
            if (confirm("Confirmar exclus√£o do andar?")) {
                try {
                    await fetchWithAuth(`/api/floors/${id}`, { method: 'DELETE' });
                    location.reload();
                } catch (e) {
                    alert('Erro ao excluir andar');
                    console.error(e);
                }
            }
        }

        function triggerReplace(id) {
            floorToReplace = id;
            document.getElementById('replace-file-input').click();
        }

        document.getElementById('replace-file-input').addEventListener('change', async e => {
            if (!e.target.files[0]) return;
            const fd = new FormData();
            fd.append('file', e.target.files[0]);
            try {
                const res = await fetchWithAuth(`/api/floors/${floorToReplace}/image`, { method: 'POST', body: fd });
                if (res.ok) location.reload();
                else alert('Erro ao substituir imagem');
            } catch (e) { console.error(e); }
        });

        document.getElementById('upload-form').addEventListener('submit', async e => {
            e.preventDefault();
            const fd = new FormData();
            fd.append('name', document.getElementById('new-floor-name').value);
            fd.append('level_order', document.getElementById('new-floor-level').value);
            fd.append('file', document.getElementById('new-floor-file').value ? document.getElementById('new-floor-file').files[0] : null);
            try {
                await fetchWithAuth('/api/floors/upload', { method: 'POST', body: fd });
                location.reload();
            } catch (e) { console.error(e); }
        });
        map.on('baselayerchange', e => {
            const f = floorsData.find(fl => fl.name === e.name);
            if (f) {
                currentFloorId = f.id;
                const paddedBounds = [[-500, -500], [f.height + 500, f.width + 500]];
                map.setMaxBounds(paddedBounds);
                updateMarkers();
            }
        });
        async function checkConnection() { try { const r = await fetchWithAuth('/api/test-db'); const s = await r.json(); document.getElementById('status-local').innerText = `Local: ${s.local}`; document.getElementById('status-ocs').innerText = `ocs: ${s.ocs}`; } catch (e) { } }
        function submitExport() {
            const types = Array.from(document.querySelectorAll('input[name="exp-type"]:checked')).map(cb => cb.value);
            const fields = Array.from(document.querySelectorAll('input[name="exp-field"]:checked')).map(cb => cb.value);

            if (types.length === 0) return alert("Selecione pelo menos um tipo.");

            const url = `/api/export/excel?types=${types.join(',')}&fields=${fields.join(',')}`;
            window.open(url, '_blank');
            document.getElementById('export-modal').classList.add('hidden');
        }
        init();
    </script>
</body>

</html>