<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netmap v2 - Indoor</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        catppuccin: {
                            base: '#1e1e2e',
                            mantle: '#181825',
                            crust: '#11111b',
                            text: '#cdd6f4',
                            surface0: '#313244',
                            surface1: '#45475a',
                            overlay0: '#6c7086',
                            blue: '#89b4fa',
                            lavender: '#b4befe',
                            red: '#f38ba8',
                            green: '#a6e3a1',
                            yellow: '#f9e2af'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        body {
            background-color: #1e1e2e;
            color: #cdd6f4;
        }

        #map {
            height: calc(100vh - 4rem);
            width: 100%;
            z-index: 10;
            background: #11111b;
        }

        .leaflet-popup-content-wrapper,
        .leaflet-popup-tip {
            background: #181825;
            color: #cdd6f4;
            border: 1px solid #313244;
        }

        .leaflet-container {
            background: #11111b;
        }

        .cursor-crosshair {
            cursor: crosshair !important;
        }
    </style>
</head>

<body class="flex flex-col h-screen overflow-hidden font-sans">

    <!-- Header -->
    <header
        class="h-16 bg-catppuccin-mantle border-b border-catppuccin-surface0 flex items-center justify-between px-6">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-catppuccin-lavender">Netmap v2</h1>
            <button onclick="toggleSidebar()"
                class="text-sm bg-catppuccin-surface0 px-3 py-1 rounded hover:bg-catppuccin-surface1">Gerenciar
                Background</button>
            <button id="btn-insert" onclick="toggleInsertMode()"
                class="text-sm bg-catppuccin-blue text-catppuccin-crust font-bold px-3 py-1 rounded hover:opacity-90">Inserir
                Item</button>
        </div>
        <div id="connection-status" class="flex gap-2 text-xs">
            <span id="status-local" class="px-2 py-1 rounded bg-catppuccin-surface0 text-catppuccin-overlay0">Local:
                Connecting...</span>
            <span id="status-ocs" class="px-2 py-1 rounded bg-catppuccin-surface0 text-catppuccin-overlay0">OCS:
                Connecting...</span>
        </div>
    </header>

    <div class="flex flex-grow relative">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="w-80 bg-catppuccin-mantle border-r border-catppuccin-surface0 hidden flex flex-col p-4 z-20 absolute h-full transition-transform">
            <h2 class="text-lg font-bold mb-4">Gerenciar Andares</h2>
            <div id="floor-list" class="space-y-2 mb-4 overflow-y-auto flex-grow"></div>
            <div class="border-t border-catppuccin-surface0 pt-4">
                <h3 class="text-sm font-bold mb-2">Upload Novo Andar</h3>
                <form id="upload-form" class="space-y-2 text-xs">
                    <input type="text" id="new-floor-name" placeholder="Nome (ex: T√©rreo)"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0 text-catppuccin-text">
                    <input type="number" id="new-floor-level" placeholder="Ordem (ex: 1)"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0 text-catppuccin-text">
                    <input type="file" id="new-floor-file" accept="image/*" class="w-full text-catppuccin-overlay0">
                    <button type="submit"
                        class="w-full bg-catppuccin-blue text-catppuccin-crust font-bold py-2 rounded hover:opacity-90">Upload</button>
                </form>
            </div>
        </aside>

        <!-- Hidden input for file replacement -->
        <input type="file" id="replace-file-input" accept="image/*" class="hidden">

        <!-- Insert Modal -->
        <div id="insert-modal"
            class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-catppuccin-mantle border border-catppuccin-surface0 p-6 rounded shadow-xl z-30 w-80">
            <h3 class="text-lg font-bold mb-4 text-catppuccin-lavender">Inserir Item</h3>
            <form id="insert-form" class="space-y-3">
                <input type="hidden" id="insert-x">
                <input type="hidden" id="insert-y">

                <div>
                    <label class="block text-xs text-catppuccin-overlay0 mb-1">Tipo</label>
                    <select id="insert-type"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0"
                        onchange="handleTypeChange()">
                        <option value="Computador">Computador</option>
                        <option value="Ponto">Ponto de Rede (Vazio)</option>
                        <option value="Ramal">Ramal</option>
                    </select>
                </div>

                <div id="field-name">
                    <label class="block text-xs text-catppuccin-overlay0 mb-1">Nome</label>
                    <input type="text" id="insert-name" placeholder="Ex: RJ-PC01"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0">
                </div>

                <div id="field-point">
                    <label class="block text-xs text-catppuccin-overlay0 mb-1">Ponto de Rede</label>
                    <input type="text" id="insert-point" placeholder="Ex: 160"
                        class="w-full bg-catppuccin-crust p-2 rounded border border-catppuccin-surface0">
                </div>

                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" onclick="closeInsertModal()"
                        class="px-3 py-1 bg-catppuccin-surface0 rounded hover:bg-catppuccin-surface1">Cancelar</button>
                    <button type="submit"
                        class="px-3 py-1 bg-catppuccin-blue text-catppuccin-crust font-bold rounded hover:opacity-90">Salvar</button>
                </div>
            </form>
        </div>

        <!-- Map -->
        <main class="flex-grow relative w-full">
            <div id="map"></div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // Init Map
        const map = L.map('map', { crs: L.CRS.Simple, minZoom: -3, maxZoom: 2, zoomSnap: 0.5 });
        const layerControl = L.control.layers(null, null, { collapsed: false, position: 'topright' }).addTo(map);
        let currentFloorId = null;
        let floorsData = [];
        let markersLayer = L.layerGroup().addTo(map);
        let allNodes = [];
        let floorToReplace = null;
        let isInsertMode = false;
        let insertMarker = null;

        async function init() {
            await fetchFloors();
            await fetchNodes();
            checkConnection();
            setInterval(checkConnection, 30000);
        }

        async function fetchFloors() {
            try {
                const res = await fetch('/api/floors');
                floorsData = await res.json();

                layerControl.remove();
                const newControl = L.control.layers(null, null, { collapsed: false, position: 'topright' }).addTo(map);

                const sidebarList = document.getElementById('floor-list');
                sidebarList.innerHTML = '';

                floorsData.forEach((floor, index) => {
                    const bounds = [[0, 0], [floor.height, floor.width]];
                    const layer = L.imageOverlay(floor.image_path, bounds);
                    newControl.addBaseLayer(layer, floor.name);

                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center bg-catppuccin-surface0 p-2 rounded text-sm";
                    item.innerHTML = `
                        <div>
                            <div class='font-bold'>${floor.name}</div>
                            <div class='text-xs text-catppuccin-overlay0'>Lvl ${floor.level_order}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="triggerReplace(${floor.id})" class="hover:text-catppuccin-blue" title="Substituir">‚ôªÔ∏è</button>
                            <button onclick="deleteFloor(${floor.id})" class="hover:text-catppuccin-red" title="Excluir">üóëÔ∏è</button>
                        </div>
                    `;
                    sidebarList.appendChild(item);

                    if (index === 0 && !currentFloorId) {
                        layer.addTo(map);
                        map.fitBounds(bounds);
                        currentFloorId = floor.id;
                    }
                });
            } catch (e) { console.error(e); }
        }

        async function fetchNodes() {
            try {
                const res = await fetch('/api/nodes');
                const data = await res.json();
                allNodes = data.features;
                updateMarkers();
            } catch (e) { }
        }

        function updateMarkers() {
            if (!currentFloorId) return;
            markersLayer.clearLayers();
            const visibleNodes = allNodes.filter(n => n.properties.floor_id === currentFloorId);

            visibleNodes.forEach(f => {
                const [y, x] = f.geometry.coordinates;
                let color = "#a6e3a1"; // Green (PC)
                if (f.properties.type === 'Ponto') color = "#f9e2af"; // Yellow (Empty)
                if (f.properties.type === 'Ramal') color = "#f38ba8"; // Red (Phone)

                const popupContent = `
                    <div class="font-sans">
                        <h3 class="font-bold text-catppuccin-lavender">${f.properties.name}</h3>
                        ${f.properties.point_number ? `<p class="text-xs text-catppuccin-blue">Ponto: ${f.properties.point_number}</p>` : ''}
                        ${f.properties.ip_address ? `<p class="text-xs text-catppuccin-text">${f.properties.ip_address}</p>` : ''}
                        <p class="text-xs text-catppuccin-overlay0">${f.properties.type}</p>
                    </div>
                `;

                L.circleMarker([x, y], { radius: 6, fillColor: color, color: "#11111b", weight: 1, fillOpacity: 0.8 })
                    .bindPopup(popupContent)
                    .addTo(markersLayer);
            });
        }

        // --- Insert Mode Logic ---
        function toggleInsertMode() {
            isInsertMode = !isInsertMode;
            const btn = document.getElementById('btn-insert');
            const mapEl = document.getElementById('map');

            if (isInsertMode) {
                btn.classList.replace('bg-catppuccin-blue', 'bg-catppuccin-green');
                btn.textContent = "Clique no Mapa...";
                mapEl.classList.add('cursor-crosshair');
            } else {
                btn.classList.replace('bg-catppuccin-green', 'bg-catppuccin-blue');
                btn.textContent = "Inserir Item";
                mapEl.classList.remove('cursor-crosshair');
                closeInsertModal();
            }
        }

        function closeInsertModal() {
            document.getElementById('insert-modal').classList.add('hidden');
            if (insertMarker) { map.removeLayer(insertMarker); insertMarker = null; }
        }

        function handleTypeChange() {
            const type = document.getElementById('insert-type').value;
            const nameDiv = document.getElementById('field-name');
            const pointDiv = document.getElementById('field-point');

            if (type === 'Ponto') {
                // For empty points, maybe "name" is less important, 
                // but our DB requires name. We can auto-set or ask.
                // Request says: "155" (Just the number).
                // Let's hide Name field and use Point number as Name? Or keep both?
                // Request: "155 (Ponto de Rede)" 
                // Let's keep Name (Label) and Point separate.
                nameDiv.classList.remove('hidden');
            } else {
                nameDiv.classList.remove('hidden');
            }
        }

        document.getElementById('insert-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentFloorId) return alert("Selecione um andar!");

            const type = document.getElementById('insert-type').value;
            const name = document.getElementById('insert-name').value;
            const point = document.getElementById('insert-point').value;
            const x = parseFloat(document.getElementById('insert-x').value);
            const y = parseFloat(document.getElementById('insert-y').value);

            // Validation
            if (type === 'Ponto' && !name) {
                // Auto-fill name with Point Number if empty
                if (point) document.getElementById('insert-name').value = point;
            }

            const payload = {
                name: document.getElementById('insert-name').value || (type + " " + point),
                type: type,
                point_number: point,
                floor_id: currentFloorId,
                x: x,
                y: y
            };

            try {
                const res = await fetch('/api/nodes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    toggleInsertMode(); // Reset
                    fetchNodes(); // Refresh
                } else {
                    alert('Erro ao salvar no banco.');
                }
            } catch (err) { console.error(err); alert('Erro de rede.'); }
        });


        // Map Events
        map.on('click', function (e) {
            if (!isInsertMode) return;

            // Show marker preview
            if (insertMarker) map.removeLayer(insertMarker);
            insertMarker = L.circleMarker(e.latlng, { radius: 6, color: 'white' }).addTo(map);

            // Open Modal
            const modal = document.getElementById('insert-modal');
            modal.classList.remove('hidden');

            // Set coords (Leaflet Lat(y), Lng(x)) -> DB X(Lng), Y(Lat)
            // Wait.. usually X is Longitude, Y is Latitude when mapped to Geo.
            // L.CRS.Simple: [y, x]. 
            // GeoJSON expects [x, y].
            // If we use L.latLng: lat is y, lng is x.
            document.getElementById('insert-x').value = e.latlng.lng.toFixed(2);
            document.getElementById('insert-y').value = e.latlng.lat.toFixed(2);

            document.getElementById('insert-name').focus();
        });

        // Other handlers (Delete, Replace, Sidebar) same as before...
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
        async function deleteFloor(id) { if (confirm("Confirmar exclus√£o?")) fetch(`/api/floors/${id}`, { method: 'DELETE' }).then(() => location.reload()); }
        function triggerReplace(id) { floorToReplace = id; document.getElementById('replace-file-input').click(); }
        document.getElementById('replace-file-input').addEventListener('change', async e => {
            const fd = new FormData(); fd.append('file', e.target.files[0]);
            await fetch(`/api/floors/${floorToReplace}/image`, { method: 'POST', body: fd }); location.reload();
        });
        document.getElementById('upload-form').addEventListener('submit', async e => {
            e.preventDefault(); const fd = new FormData();
            fd.append('name', document.getElementById('new-floor-name').value);
            fd.append('level_order', document.getElementById('new-floor-level').value);
            fd.append('file', document.getElementById('new-floor-file').files[0]);
            await fetch('/api/floors/upload', { method: 'POST', body: fd }); location.reload();
        });
        map.on('baselayerchange', e => {
            const f = floorsData.find(fl => fl.name === e.name);
            if (f) { currentFloorId = f.id; map.setMaxBounds([[0, 0], [f.height, f.width]]); updateMarkers(); }
        });
        async function checkConnection() { try { const r = await fetch('/api/test-db'); const s = await r.json(); document.getElementById('status-local').textContent = `Local: ${s.local}`; document.getElementById('status-ocs').textContent = `OCS: ${s.ocs}`; } catch (e) { } }

        init();
    </script>
</body>

</html>